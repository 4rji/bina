#!/usr/bin/env bash

# List of packages to install
packages=("build-essential" "libpam0g-dev" "libssl-dev" "libselinux1-dev" "libtool" "pkg-config" "libaudit-dev" "libbsd-dev" "autoconf" "automake")

# Check if a package is installed (Debian/Ubuntu/Kali)
is_installed_apt() {
    dpkg -l "$1" | grep -q '^ii'
}

# Check if a package is installed (CentOS/RHEL)
is_installed_yum() {
    yum list installed "$1" &> /dev/null
}

# Check if a package is installed (Fedora)
is_installed_dnf() {
    dnf list installed "$1" &> /dev/null
}

# Check if a package is installed (Arch Linux)
is_installed_pacman() {
    pacman -Qi "$1" &> /dev/null
}

# Detect operating system
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$ID
fi

# Install packages based on the OS
for pkg in "${packages[@]}"; do
    case $OS in
        "debian"|"ubuntu"|"kali")
            if ! is_installed_apt "$pkg"; then
                echo "Installing package $pkg..."
                sudo apt-get install -y "$pkg"
            fi
            ;;
        "centos"|"rhel")
            if ! is_installed_yum "$pkg"; then
                echo "Installing package $pkg..."
                sudo yum install -y "$pkg"
            fi
            ;;
        "fedora")
            if ! is_installed_dnf "$pkg"; then
                echo "Installing package $pkg..."
                sudo dnf install -y "$pkg"
            fi
            ;;
        "arch")
            if ! is_installed_pacman "$pkg"; then
                echo "Installing package $pkg..."
                sudo pacman -S --noconfirm "$pkg"
            fi
            ;;
        *)
            ;;
    esac
done

# Get current sudo version
current_version=$(sudo -V | grep -oP '(?<=Sudo version )\d+\.\d+\.\d+' | head -n 1)

# Define minimum required version
required_version="1.9.12"

echo ""
echo -e "\033[36m_________________________________________________________\033[0m"
echo ""

# Compare versions
if [[ "$(printf '%s\n' "$current_version" "$required_version" | sort -V | head -n1)" == "$current_version" ]] && [[ "$current_version" != "$required_version" ]]; then
    echo -e "\033[32mCurrent sudo version is $current_version, which is lower than $required_version. Proceeding with update...\033[0m"
    
    echo ""
    echo -e "\033[36m_________________________________________________________\033[0m"
    echo ""

    # Update sudo
    sudo apt update
    #sudo apt install -y build-essential libpam0g-dev libssl-dev libselinux1-dev libtool pkg-config libaudit-dev libbsd-dev autoconf automake 

    wget https://www.sudo.ws/dist/sudo-1.9.15.tar.gz
    tar -xzf sudo-1.9.15.tar.gz

    cd sudo-1.9.15

    sudo ./configure
    sudo make
    sudo make install

    echo ""
    echo -e "\033[33mUpdate completed.\033[0m"
    echo ""
    echo -e "\033[36m_________________________________________________________\033[0m"
    echo ""

    # Ask user if they want to log out
    read -p $'\033[35mDo you want to log out now? [y/n]: \033[0m' choice

    echo ""
    echo -e "\033[36m_________________________________________________________\033[0m"
    echo ""

    if [[ "$choice" =~ ^[yY]$ ]]; then
        echo -e "\033[31mLogging out current session...\033[0m"
        pkill -KILL -u $USER
    else
        echo -e "\033[33mOperation cancelled.\033[0m"
    fi

else
    echo -e "\033[34mCurrent sudo version is $current_version, which is greater or equal to $required_version. No update needed.\033[0m"
    echo ""
    echo -e "\033[36m_________________________________________________________\033[0m"
    echo ""
    exit 0
fi