#!/usr/bin/env bash
set -euo pipefail

echo_msg() {
  echo ""
  echo "=============================================="
  echo "$1"
  echo "=============================================="
  echo ""
}

usage() {
  echo ""
  echo -e "\033[36mUsage:\033[0m  $0 -s (server)  |  -c [ips|file] (inst-client)  |  -m [ips|file] (inst-client-mac)  |  -r (execute)"
  echo ""
  echo -e "\033[36mRECOMENDADO:\033[0m  Puedes pasar IPs separadas por espacios o comas, o un archivo con una IP por lÃ­nea. "
  echo "adjuntar o usar:  /opt/4rji/bin/shadowips"
  echo ""
  exit 1
}

ensure_dir() {
  SSHA_DIR="$HOME/.ssha"
  mkdir -p "$SSHA_DIR"
  chmod 700 "$SSHA_DIR"
}

# --- Parse options ---
[ $# -eq 0 ] && usage

MODE=""
while getopts ":scmr" opt; do
  case "$opt" in
    s) MODE="s" ;;
    c) MODE="c" ;;
    m) MODE="m" ;;
    r) MODE="r" ;;
    *) usage ;;
  esac
done
shift $((OPTIND-1))   # remaining args are IPs or file
ARGS=("$@")

case "$MODE" in
  s)
    echo_msg "SERVER INSTALL (Debian/Ubuntu)"
    
    if ! dpkg -s shadowsocks-libev >/dev/null 2>&1; then
      sudo apt install -y shadowsocks-libev
    else
      echo -e "\033[33mAlready installed.\033[0m"
      echo ""
    fi
    sudo tee /etc/shadowsocks-libev/config.json >/dev/null <<'EOF'
{
  "server": "0.0.0.0",
  "server_port": 8388,
  "password": "nalanga12",
  "method": "aes-256-gcm",
  "timeout": 300,
  "fast_open": true
}
EOF
    sudo systemctl enable shadowsocks-libev
    sudo systemctl restart shadowsocks-libev
    echo ""
    ss -tulpn | grep 8388
    echo ""
    echo -e "\033[32mSERVER READY ON PORT 8388\033[0m"
    echo ""
    echo -e "\033[36mTo start server manually:\033[0m"
    echo "ss-server -c /etc/shadowsocks-libev/config.json -v"
    echo ""
    echo "pidof ss-server and kill -9"
    ;;

  c)
    ensure_dir
    echo_msg "CLIENT CONFIGURATION (Linux)"
    
    sudo apt install -y shadowsocks-libev
    parse_ips_input "${ARGS[@]}"
    for ip in "${IP_LIST[@]}"; do
      write_client_config "$ip" "linux"
    done
    ;;

  m)
    ensure_dir
    echo_msg "CLIENT CONFIGURATION (macOS)"
    if ! command -v brew >/dev/null 2>&1; then
      echo -e "\033[31mHomebrew not found. Install Homebrew first.\033[0m"
      exit 1
    fi
    brew list shadowsocks-libev >/dev/null 2>&1 || brew install shadowsocks-libev
    parse_ips_input "${ARGS[@]}"
    for ip in "${IP_LIST[@]}"; do
      write_client_config "$ip" "macos"
    done
    ;;

  r)
    run_from_saved
    ;;

  *)
    usage
    ;;
esac