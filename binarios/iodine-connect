#!/usr/bin/env python3
import subprocess
import sys

# Configuración
authority = "mic2.4rji.com"
password = "carp"
host = "tunel.midominio.com"
remote_ip = "172.16.0.1"

# Inicia iodine y captura salida
print(f"Iniciando iodine contra {host}...")
proc = subprocess.Popen(
    ["sudo", "iodine", "-P", password, "-T", "A", authority, host],
    stdout=subprocess.PIPE,
    stderr=subprocess.STDOUT,
    text=True
)

# Espera a que iodine confirme la conexión
for line in proc.stdout:
    sys.stdout.write(line)
    if "Connection setup complete" in line:
        break

print("\nConexión establecida.")

# Pregunta para verificar conectividad
def prompt_yes_no(msg, default_yes=False):
    yn = input(msg).strip().lower()
    if yn == "":
        return default_yes
    return yn[0] == "y"

if prompt_yes_no("¿Verificar conectividad con ping? [y/N]: ", False):
    ret = subprocess.call(["ping", "-c", "1", remote_ip])
    if ret == 0:
        print("✅ El túnel responde correctamente.")
    else:
        print("❌ No hubo respuesta del túnel.")

# Pregunta para detener iodine
if prompt_yes_no("¿Detener iodine? [Y/n]: ", True):
    proc.terminate()
    proc.wait(timeout=5)
    print("iodine detenido.")
else:
    print(f"iodine sigue corriendo (PID {proc.pid}).")
