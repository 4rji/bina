#!/usr/bin/env python3
import subprocess
import sys

# Configuration
authority = "mic2.4rji.com"
password = "carp"
host = "tunel.midominio.com"
remote_ip = "172.16.0.1"

# Start iodine and capture output
print(f"Starting iodine against {host}...")
proc = subprocess.Popen(
    ["sudo", "iodine", "-P", password, "-T", "A", authority, host],
    stdout=subprocess.PIPE,
    stderr=subprocess.STDOUT,
    text=True
)

# Wait for iodine to confirm the connection
for line in proc.stdout:
    sys.stdout.write(line)
    if "Connection setup complete" in line:
        break

print("\nConnection established.")

# Yes/No prompt function
def prompt_yes_no(msg, default_yes=False):
    yn = input(msg).strip().lower()
    if yn == "":
        return default_yes
    return yn[0] == "y"

# Ask to verify connectivity
if prompt_yes_no("Verify connectivity with ping? [Y/n]: ", True):
    ret = subprocess.call(["ping", "-c", "1", remote_ip])
    if ret == 0:
        print("✅ The tunnel responds correctly.")
    else:
        print("❌ No response from the tunnel.")

# Ask to stop iodine
if prompt_yes_no("Stop iodine? (or use sudo pkill iodine) [Y/n]: ", True):
    proc.terminate()
    proc.wait(timeout=5)
    print("iodine stopped.")
else:
    print(f"iodine is still running (PID {proc.pid}).")

