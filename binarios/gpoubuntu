#!/usr/bin/env bash
set -euo pipefail

[[ "${EUID:-$(id -u)}" -eq 0 ]] || { echo "Run as root"; exit 1; }

ts() { date +"%Y%m%d-%H%M%S"; }
bk() { [[ -f "$1" ]] && cp -a "$1" "$1.bak.$(ts)"; }
have() { command -v "$1" >/dev/null 2>&1; }

ensure_kv() { # key=value in file
  local f="$1" k="$2" v="$3"
  [[ -f "$f" ]] || { mkdir -p "$(dirname "$f")"; touch "$f"; }
  if grep -Eq "^[[:space:]]*${k}[[:space:]]*=" "$f"; then
    sed -ri "s|^[[:space:]]*${k}[[:space:]]*=.*|${k} = ${v}|g" "$f"
  else
    printf "%s = %s\n" "$k" "$v" >> "$f"
  fi
}

ensure_line_once() {
  local f="$1" line="$2"
  [[ -f "$f" ]] || { mkdir -p "$(dirname "$f")"; touch "$f"; }
  grep -Fxq "$line" "$f" || printf "%s\n" "$line" >> "$f"
}

human_users() {
  awk -F: '($3>=1000 && $3<60000) && ($7 !~ /(\/usr\/sbin\/nologin|\/sbin\/nologin|\/bin\/false)/){print $1}' /etc/passwd
}

# --- 1,2,10: password complexity / length ---
apply_pwquality() {
  local f="/etc/security/pwquality.conf"
  bk "$f"
  ensure_kv "$f" "minlen" "15"
  ensure_kv "$f" "minclass" "4"
  ensure_kv "$f" "ucredit" "-1"
  ensure_kv "$f" "lcredit" "-1"
  ensure_kv "$f" "dcredit" "-1"
  ensure_kv "$f" "ocredit" "-1"
  ensure_kv "$f" "dictcheck" "1"
  ensure_kv "$f" "gecoscheck" "1"
}

# --- 3,4: lockout policy ---
apply_faillock_conf() {
  local f="/etc/security/faillock.conf"
  bk "$f"
  ensure_kv "$f" "deny" "5"
  ensure_kv "$f" "fail_interval" "900"   # 15 minutes
  ensure_kv "$f" "unlock_time" "900"     # 15 minutes
}

# --- 5,8,9: aging + strong hash (no reversible) ---
apply_login_defs() {
  local f="/etc/login.defs"
  [[ -f "$f" ]] || return 0
  bk "$f"
  if grep -Eq '^[[:space:]]*PASS_MAX_DAYS' "$f"; then
    sed -ri 's/^[[:space:]]*PASS_MAX_DAYS[[:space:]]+.*/PASS_MAX_DAYS   90/g' "$f"
  else
    echo "PASS_MAX_DAYS   90" >> "$f"
  fi
  if grep -Eq '^[[:space:]]*PASS_MIN_DAYS' "$f"; then
    sed -ri 's/^[[:space:]]*PASS_MIN_DAYS[[:space:]]+.*/PASS_MIN_DAYS   1/g' "$f"
  else
    echo "PASS_MIN_DAYS   1" >> "$f"
  fi

  # Ubuntu 24 uses YESCRYPT by default on modern installs; enforce it (no md5/reversible).
  if grep -Eq '^[[:space:]]*ENCRYPT_METHOD' "$f"; then
    sed -ri 's/^[[:space:]]*ENCRYPT_METHOD[[:space:]]+.*/ENCRYPT_METHOD YESCRYPT/g' "$f"
  else
    echo "ENCRYPT_METHOD YESCRYPT" >> "$f"
  fi
}

apply_chage_humans() {
  while IFS= read -r u; do
    chage -M 90 "$u" 2>/dev/null || true
    chage -m 1  "$u" 2>/dev/null || true
  done < <(human_users)
}

# --- 6: remember last 3 passwords ---
apply_common_password() {
  local f="/etc/pam.d/common-password"
  bk "$f"

  # Ensure pwquality
  if ! grep -Eq 'pam_pwquality\.so' "$f"; then
    sed -i '1ipassword requisite pam_pwquality.so retry=3' "$f"
  fi

  # Ensure pwhistory remember=3
  if grep -Eq 'pam_pwhistory\.so' "$f"; then
    sed -ri 's/(pam_pwhistory\.so.*)(remember=)[0-9]+/\1remember=3/' "$f" || true
    grep -Eq 'pam_pwhistory\.so.*remember=3' "$f" || sed -ri 's/(pam_pwhistory\.so.*)/\1 remember=3/' "$f"
  else
    # place before pam_unix if possible
    if grep -Eq '^password\s+\[success=.*\]\s+pam_unix\.so' "$f"; then
      sed -ri 's|^(password\s+\[success=.*\]\s+pam_unix\.so.*)$|password required pam_pwhistory.so remember=3 use_authtok\n\1|' "$f"
    else
      echo 'password required pam_pwhistory.so remember=3 use_authtok' >> "$f"
    fi
  fi
}

# --- 3,4: PAM faillock wiring (Ubuntu path) ---
apply_common_auth_account() {
  local ca="/etc/pam.d/common-auth"
  local cc="/etc/pam.d/common-account"
  bk "$ca"; bk "$cc"

  # Only if module exists
  if [[ ! -f /lib/x86_64-linux-gnu/security/pam_faillock.so && ! -f /lib/security/pam_faillock.so ]]; then
    echo "pam_faillock.so not found; skipping PAM lockout wiring"
    return 0
  fi

  # preauth near top
  if ! grep -Eq 'pam_faillock\.so.*preauth' "$ca"; then
    sed -i '1iauth required pam_faillock.so preauth silent deny=5 fail_interval=900 unlock_time=900' "$ca"
  fi

  # authfail near end (after pam_unix typically)
  if ! grep -Eq 'pam_faillock\.so.*authfail' "$ca"; then
    echo 'auth [default=die] pam_faillock.so authfail deny=5 fail_interval=900 unlock_time=900' >> "$ca"
  fi

  # account required
  if ! grep -Eq '^account\s+required\s+pam_faillock\.so' "$cc"; then
    echo 'account required pam_faillock.so' >> "$cc"
  fi
}

# --- 11: Kerberos time tolerance 5 minutes ---
apply_kerberos_clockskew() {
  local f="/etc/krb5.conf"
  [[ -f "$f" ]] || return 0
  bk "$f"

  if grep -Eq '^[[:space:]]*clockskew[[:space:]]*=' "$f"; then
    sed -ri 's/^[[:space:]]*clockskew[[:space:]]*=.*/    clockskew = 300/g' "$f"
    return 0
  fi

  if grep -Eq '^\[libdefaults\]' "$f"; then
    awk '
      BEGIN{done=0}
      /^\[libdefaults\]/{print; in=1; next}
      in==1 && done==0 && /^\[/{print "    clockskew = 300"; done=1; in=0}
      {print}
      END{ if(in==1 && done==0){print "    clockskew = 300"} }
    ' "$f" > "${f}.tmp" && mv "${f}.tmp" "$f"
  else
    printf "\n[libdefaults]\n    clockskew = 300\n" >> "$f"
  fi
}

main() {
  # Packages (Ubuntu 24 usually already has these, but ensure)
  if have apt-get; then
    apt-get update -y
    apt-get install -y libpam-pwquality libpam-modules libpam-modules-bin
  fi

  apply_pwquality
  apply_faillock_conf
  apply_login_defs

  apply_common_password
  apply_common_auth_account
  apply_kerberos_clockskew

  apply_chage_humans

  echo "OK (Ubuntu 24): minlen=15 + 4 classes, remember=3, lockout 5/15m unlock 15m, maxdays=90, mindays=1(humans), YESCRYPT, krb5 clockskew=300"
}

main "$@"
