#!/usr/bin/env bash
echo ""
echo "_________________________________________________________"
echo ""
echo " NTP Server Installation and Configuration Script for Debian 10"
echo "_________________________________________________________"
echo ""

# Exit immediately if a command exits with a non-zero status
set -e

# Function to display messages
echo_msg() {
    echo ""
    echo $'\033[1;34m==============================================\033[0m'
    echo $'\033[1;36m'"$1"$'\033[0m'
    echo $'\033[1;34m==============================================\033[0m'
    echo ""
}

# Ensure the script is run as root
if [ "$EUID" -ne 0 ]; then
    echo $'\033[1;31mPlease run this script with sudo or as root.\033[0m'
    exit 1
fi

# Step 1: Update the System
echo_msg "Updating the system packages..."
apt update && apt upgrade -y

# Step 2: Install NTP
echo_msg "Installing NTP service..."
apt install ntp -y

# Step 3: Backup Existing NTP Configuration
echo_msg "Backing up the existing NTP configuration..."
if [ -f /etc/ntp.conf ]; then
    cp /etc/ntp.conf /etc/ntp.conf.bak
    echo $'\033[1;32mBackup created: /etc/ntp.conf.bak\033[0m'
else
    echo $'\033[1;33mNo existing /etc/ntp.conf found. Skipping backup.\033[0m'
fi

# Step 4: Configure NTP as a Server
echo_msg "Configuring NTP as a server..."
cat > /etc/ntp.conf <<EOL
# NTP configuration for Debian 10 NTP Server

# Use servers from the NTP Pool Project
server 0.debian.pool.ntp.org iburst
server 1.debian.pool.ntp.org iburst
server 2.debian.pool.ntp.org iburst
server 3.debian.pool.ntp.org iburst

# Drift file
driftfile /var/lib/ntp/ntp.drift

# Enable IPv6 support
interface listen on 0.0.0.0
interface listen on ::0

# Access control configuration
restrict default kod nomodify notrap nopeer noquery
restrict 127.0.0.1
restrict ::1
restrict 192.168.1.0 mask 255.255.255.0 nomodify notrap
EOL

# Step 5: Configure the Firewall to Allow NTP Traffic
echo_msg "Configuring the firewall to allow NTP traffic..."

if command -v ufw >/dev/null 2>&1; then
    echo $'\033[1;32mUFW is already installed.\033[0m'
else
    echo $'\033[1;33mUFW not found. Installing UFW...\033[0m'
    apt install ufw -y
    echo $'\033[1;32mUFW installed.\033[0m'
fi

ufw allow 123/udp

if ufw status | grep -qw "Status: inactive"; then
    echo $'\033[1;33mEnabling UFW...\033[0m'
    ufw --force enable
else
    echo $'\033[1;32mUFW is already enabled.\033[0m'
fi

# Step 6: Restart and Enable NTP Service
echo_msg "Restarting and enabling NTP service..."
systemctl restart ntp
systemctl enable ntp

# Step 7: Verify NTP Service Status
echo_msg "Verifying NTP service status..."
systemctl status ntp --no-pager

# Step 8: Verify NTP Synchronization and Server Status
echo_msg "Checking NTP synchronization and server peers..."
ntpq -p

echo_msg "NTP server installation and configuration completed successfully."
echo ""
echo "_________________________________________________________"
echo $'\033[1;33mTo verify connections, run: ntpq -p\033[0m'
echo "_________________________________________________________"
echo ""