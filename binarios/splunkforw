#!/usr/bin/env bash
set -e


# ---------- banner instructions (always first) ----------
printf "\n"
printf "\033[37mStep 1: Install Splunk Universal Forwarder (Linux):\033[0m\n\n"

printf "\033[33m• Debian / Ubuntu (.deb)\033[0m\n"
printf "\033[32m  sudo dpkg -i splunkforwarder-<version>-linux-amd64.deb\033[0m\n\n"

printf "\033[33m• RHEL / CentOS / Rocky / Alma (.rpm)\033[0m\n"
printf "\033[32m  sudo rpm -i splunkforwarder-<version>.x86_64.rpm\033[0m\n\n"

printf "\033[33m• Generic Linux (.tgz)\033[0m\n"
printf "\033[32m  sudo tar -xvzf splunkforwarder-<version>-linux-amd64.tgz -C /opt\033[0m\n\n"

printf "\033[36m_____________________ cd /opt/splunkforwarder/bin ____________________________\033[0m\n\n"

printf "\033[37mStep 2: Start Splunk with the command:\033[0m\n"
printf "\033[32msudo ./splunk start --accept-license\033[0m\n\n"

printf "\033[37mStep 3: Add a forward server with:\033[0m\n"
printf "\033[32msudo ./splunk add forward-server <server_ip>:<port>\033[0m\n\n"

printf "\033[37mStep 4: Enable Splunk to start on boot with:\033[0m\n"
printf "\033[32msudo systemctl enable --now SplunkForwarder\033[0m\n\n"

printf "\033[37mStep 5: Check the status of SplunkForwarder with:\033[0m\n"
printf "\033[32msudo systemctl status SplunkForwarder\033[0m\n\n"

printf "\033[37mStep 6: Monitor a log file with:\033[0m\n"
printf "\033[32msudo ./splunk add monitor /var/log/auth.log -index linux_logs\033[0m\n\n"

printf "\033[37mStep 7: Verify active forwarders with:\033[0m\n"
printf "\033[32msudo ./splunk list forward-server\033[0m\n\n"

# ---------- helper ----------
echo_msg() {
  echo ""
  echo -e "\033[36m==============================================\033[0m"
  echo -e "\033[1;33m$1\033[0m"
  echo -e "\033[36m==============================================\033[0m"
  echo ""
}

echo -e "\033[34m_________________________________________________________\033[0m"
echo ""
echo -e "\033[34mSelect the operating system for Splunk Universal Forwarder 10.0.2:\033[0m"
echo ""
echo -e "  1. \033[36mWindows (64-bit)\033[0m"
echo -e "  2. \033[36mLinux (x86_64 only)\033[0m"
echo ""
read -n1 -p "  Enter your choice (1/2): " os_choice
echo ""

case "$os_choice" in
  1) # Windows
    echo_msg "Downloading Splunk Universal Forwarder for Windows 64-bit (10.0.2)"
    wget -O splunkforwarder-10.0.2-windows-x64.msi \
      "https://download.splunk.com/products/universalforwarder/releases/10.0.2/windows/splunkforwarder-10.0.2-e2d18b4767e9-windows-x64.msi"
    ;;

  2) # Linux (NO ARM)
    echo -e "\033[34m_________________________________________________________\033[0m"
    echo ""
    echo -e "\033[34mSelect the package for Linux (10.0.2):\033[0m"
    echo ""
    echo -e "  1. \033[36m64-bit rpm (x86_64)\033[0m"
    echo -e "  2. \033[36m64-bit deb (amd64)\033[0m"
    echo -e "  3. \033[36m64-bit tgz (amd64)\033[0m"
    echo ""
    read -n1 -p "  Enter your choice (1/2/3): " linux_version
    echo ""

    case "$linux_version" in
      1)
        echo_msg "Downloading Splunk UF for Linux 64-bit rpm (10.0.2)"
        wget -O splunkforwarder-10.0.2-linux-x86_64.rpm \
          "https://download.splunk.com/products/universalforwarder/releases/10.0.2/linux/splunkforwarder-10.0.2-e2d18b4767e9.x86_64.rpm"
        ;;
      2)
        echo_msg "Downloading Splunk UF for Linux 64-bit deb (10.0.2)"
        wget -O splunkforwarder-10.0.2-linux-amd64.deb \
          "https://download.splunk.com/products/universalforwarder/releases/10.0.2/linux/splunkforwarder-10.0.2-e2d18b4767e9-linux-amd64.deb"
        ;;
      3)
        echo_msg "Downloading Splunk UF for Linux 64-bit tgz (10.0.2)"
        wget -O splunkforwarder-10.0.2-linux-amd64.tgz \
          "https://download.splunk.com/products/universalforwarder/releases/10.0.2/linux/splunkforwarder-10.0.2-e2d18b4767e9-linux-amd64.tgz"
        ;;
      *)
        echo -e "\033[31mInvalid selection\033[0m"; exit 1;;
    esac
    ;;
  *)
    echo -e "\033[31mInvalid selection\033[0m"; exit 1;;
esac

echo ""
echo "for auth.logs monitor:"
echo "cat /opt/splunkforwarder/etc/apps/search/local/inputs.conf"
echo ""
echo -e "\033[32mDownload complete.\033[0m"