#!/usr/bin/env bash
set -euo pipefail

# Auto-sudo
if [[ $EUID -ne 0 ]]; then
  exec sudo bash "$0" "$@"
fi

CONF="/etc/chrony.conf"

usage() {
  echo ""
  echo "Usage: $0 -i | -c | -s"
  echo ""
  echo "  -i   Install & configure Chrony as NTP server"
  echo "  -c   Show connected NTP clients"
  echo "  -s   Show NTP sources"
  echo ""
  exit 1
}

install_server() {

  DEFAULT_ALLOW="172.20.0.0/16"
  DEFAULT_STRATUM="10"

  echo ""
  echo "===================================================="
  echo " Chrony NTP Server Setup (Ubuntu 22/24)"
  echo "===================================================="
  echo ""
  echo "Enter MULTIPLE subnets separated by commas."
  echo "Example: 172.20.0.0/16,192.168.88.0/24,10.10.0.0/16"
  echo ""

  read -r -p "Allow clients CIDR list [${DEFAULT_ALLOW}]: " ALLOW_LIST
  ALLOW_LIST="${ALLOW_LIST:-$DEFAULT_ALLOW}"

  read -r -p "Local stratum when offline [${DEFAULT_STRATUM}]: " STRATUM
  STRATUM="${STRATUM:-$DEFAULT_STRATUM}"

    echo "[*] Installing chrony..."
  if command -v dnf >/dev/null 2>&1; then
    dnf -y install chrony
    SVC="chronyd"
  else
    export DEBIAN_FRONTEND=noninteractive
    apt-get update -y
    apt-get install -y chrony
    SVC="chrony"
  fi

  BACKUP="${CONF}.bak.$(date +%Y%m%d%H%M%S)"
  cp -a "$CONF" "$BACKUP" 2>/dev/null || true

  # Build allow lines
  ALLOW_LINES=""
  IFS=',' read -ra NETS <<< "$ALLOW_LIST"
  for net in "${NETS[@]}"; do
    net="$(echo "$net" | xargs)"
    ALLOW_LINES+="allow $net"$'\n'
  done

  cat > "$CONF" <<EOF
# Managed by chrony-ntp-server.sh

# Upstream pools
pool 0.pool.ntp.org iburst
pool 1.pool.ntp.org iburst

# Allowed client networks
${ALLOW_LINES}

# Serve time if isolated
local stratum ${STRATUM}

driftfile /var/lib/chrony/chrony.drift
makestep 1.0 3
rtcsync
logdir /var/log/chrony
EOF

  systemctl enable --now "$SVC"
  systemctl restart "$SVC"

  echo ""
  echo "[+] NTP server installed."
  echo "    $0 -s   (show sources)"
  echo "    $0 -c   (show clients)"
}

show_clients() {
  chronyc clients
}

show_sources() {
  chronyc sources -v
}

while getopts ":ics" opt; do
  case $opt in
    i) install_server ;;
    c) show_clients ;;
    s) show_sources ;;
    *) usage ;;
  esac
done

if [[ $# -eq 0 ]]; then
  usage
fi