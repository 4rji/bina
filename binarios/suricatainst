#!/usr/bin/env bash
# Instala y configura Suricata con interfaz en modo promiscuo (auto/override)
# Uso opcional: IFACE=eth1 ./setup-suricata.sh  (o ./setup-suricata.sh eth1)

set -euo pipefail

# ===== Colores ANSI =====
G="\e[92m"; Y="\e[93m"; B="\e[94m"; R="\e[91m"; GR="\e[90m"; X="\e[0m"

echo -e "\n${B}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${X}"
echo -e "${B}                 INSTALACIÃ“N â€¢ SURICATA (APT)                 ${X}"
echo -e "${B}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${X}\n"

# ===== Root requerido =====
if [[ $EUID -ne 0 ]]; then
  echo -e "${R}âœ– Ejecuta como root${X}\n"; exit 1
fi

# ===== Descubrir interfaz =====
ARG_IFACE="${1:-}"
ENV_IFACE="${IFACE:-}"
choose_iface() {
  # 1) arg/env; 2) por default route; 3) primera fÃ­sica UP
  if [[ -n "$ARG_IFACE" ]]; then echo "$ARG_IFACE"; return; fi
  if [[ -n "$ENV_IFACE" ]]; then echo "$ENV_IFACE"; return; fi

  DEF=$(ip route show default 2>/dev/null | awk '/default/ {for(i=1;i<=NF;i++) if($i=="dev"){print $(i+1); exit}}')
  if [[ -n "${DEF:-}" ]]; then echo "$DEF"; return; fi

  ip -o link show up | awk -F': ' '{print $2}' \
    | grep -Eiv '^(lo|docker.*|br-.*|veth.*|wg.*|tun.*|tap.*|virbr.*|vmnet.*|tailscale.*)$' \
    | head -n1
}
IFACE="$(choose_iface || true)"
if [[ -z "${IFACE:-}" ]]; then
  echo -e "${R}âœ– No se pudo detectar interfaz. Pasa una: ${Y}./setup-suricata.sh eth1${X}\n"
  exit 1
fi

echo -e "${G}âœ” Interfaz detectada:${X} ${Y}${IFACE}${X}\n"

# ===== APT =====
echo -e "${G}â†’${X} ${Y}sudo apt update${X}\n"
apt update -y

echo -e "${G}â†’${X} ${Y}sudo apt install suricata -y${X}\n"
apt install -y suricata

# ===== Reglas =====
echo -e "${G}â†’${X} ${Y}sudo suricata-update${X}\n"
suricata-update

# ===== Config: /etc/default/suricata (modo systemd con -i IFACE) =====
echo -e "${G}â†’${X} ${Y}Configurando /etc/default/suricata${X}\n"
install -m 0644 /dev/null /etc/default/suricata || true
cat >/etc/default/suricata <<EOF
# Autogenerado: interfaz y opciones de Suricata
LISTENMODE=af-packet
IFACE="${IFACE}"
SURICATA_OPTIONS="-i \${IFACE}"
EOF

# ===== Modo promiscuo (sesiÃ³n actual) =====
echo -e "${G}â†’${X} ${Y}Activando modo promiscuo en ${IFACE}${X}\n"
ip link set "${IFACE}" promisc on

# ===== Probar sintaxis =====
echo -e "${G}â†’${X} ${Y}Validando configuraciÃ³n${X}\n"
suricata -T -c /etc/suricata/suricata.yaml >/dev/null

# ===== Habilitar servicio =====
echo -e "${G}â†’${X} ${Y}sudo systemctl enable --now suricata${X}\n"
systemctl enable --now suricata

# ===== Estado rÃ¡pido =====
echo -e "${G}â†’${X} ${Y}systemctl --no-pager --full -l status suricata | sed -n '1,15p'${X}\n"
systemctl --no-pager --full -l status suricata | sed -n '1,15p' || true

# ===== Mensajes finales =====
echo
echo -e "${B}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${X}"
echo -e "${G}âœ… Suricata instalado y corriendo en interfaz:${X} ${Y}${IFACE}${X}\n"
echo -e "${G}ðŸ“„ Config:${X} ${Y}/etc/suricata/suricata.yaml${X}"
echo -e "${G}âš™  Servicio:${X} ${Y}systemctl [status|restart] suricata${X}"
echo -e "${G}ðŸ§ª Reglas:${X} ${Y}suricata-update${X}\n"
echo -e "${G}ðŸ”Ž Logs (rÃ¡pido):${X} ${Y}tail -f /var/log/suricata/fast.log${X}\n"
echo -e "${B}â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€${X}\n"