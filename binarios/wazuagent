#!/usr/bin/env bash
set -euo pipefail

WAZUH_MANAGER="${WAZUH_MANAGER:-10.0.0.2}"
WAZUH_VERSION_APT="4.13.1-1"
WAZUH_VERSION_RPM="4.13.1-1"

have() { command -v "$1" >/dev/null 2>&1; }

detect_pm() {
  if have apt-get; then echo "apt"
  elif have dnf; then echo "dnf"
  elif have yum; then echo "yum"
  else echo "none"
  fi
}

install_wazuh_apt() {
  curl -s https://packages.wazuh.com/key/GPG-KEY-WAZUH \
    | sudo gpg --no-default-keyring --keyring gnupg-ring:/usr/share/keyrings/wazuh.gpg --import
  sudo chmod 644 /usr/share/keyrings/wazuh.gpg

  echo "deb [signed-by=/usr/share/keyrings/wazuh.gpg] https://packages.wazuh.com/4.x/apt/ stable main" \
    | sudo tee /etc/apt/sources.list.d/wazuh.list >/dev/null

  sudo apt-get update
  sudo WAZUH_MANAGER="$WAZUH_MANAGER" apt-get install -y "wazuh-agent=${WAZUH_VERSION_APT}"

  sudo systemctl daemon-reload
  sudo systemctl enable --now wazuh-agent
}

install_wazuh_rpm() {
  local pm="$1"
  sudo WAZUH_MANAGER="$WAZUH_MANAGER" "$pm" install -y "wazuh-agent-${WAZUH_VERSION_RPM}"

  sudo systemctl daemon-reload
  sudo systemctl enable --now wazuh-agent
}

disable_repo_apt() {
  if [ -f /etc/apt/sources.list.d/wazuh.list ]; then
    sudo sed -i 's/^deb/#deb/' /etc/apt/sources.list.d/wazuh.list
  fi
  sudo apt-get update
}

disable_repo_rpm() {
  if [ -f /etc/yum.repos.d/wazuh.repo ]; then
    sudo sed -i 's/^enabled=1/enabled=0/' /etc/yum.repos.d/wazuh.repo
  fi
}

pm="$(detect_pm)"
if [ "$pm" = "none" ]; then
  echo "[!] No supported package manager found (apt/dnf/yum)."
  exit 1
fi

echo
echo "=== Wazuh Agent Menu (${pm}) ==="
echo "1) Install Wazuh agent"
echo "2) Disable Wazuh repo"
echo "3) Exit"
echo

read -rp "Select option [1-3]: " opt
case "$opt" in
  1)
    echo "[*] Installing Wazuh agent (manager: $WAZUH_MANAGER)"
    if [ "$pm" = "apt" ]; then
      install_wazuh_apt
    else
      install_wazuh_rpm "$pm"
    fi
    echo "[OK] Wazuh agent installed and started."
    ;;
  2)
    echo "[*] Disabling Wazuh repo"
    if [ "$pm" = "apt" ]; then
      disable_repo_apt
    else
      disable_repo_rpm
    fi
    echo "[OK] Repo disabled."
    ;;
  3)
    exit 0
    ;;
  *)
    echo "[!] Invalid option."
    exit 1
    ;;
esac
