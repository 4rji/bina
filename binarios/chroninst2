#!/usr/bin/env bash
set -euo pipefail

# chrony-ntp-client-setup.sh
# Works on: Ubuntu 22/24, Fedora, Oracle Linux 9.x (RHEL-like)
# Installs chrony, configures as NTP client to a given server IP/hostname, enables service.

if [[ $EUID -ne 0 ]]; then
  echo "Run as root (sudo)." >&2
  exit 1
fi

# --- Detect OS + config paths ---
OS_ID=""
OS_LIKE=""
if [[ -f /etc/os-release ]]; then
  # shellcheck disable=SC1091
  . /etc/os-release
  OS_ID="${ID:-}"
  OS_LIKE="${ID_LIKE:-}"
fi

is_ubuntu=false
is_rhel_like=false

if [[ "$OS_ID" == "ubuntu" ]]; then
  is_ubuntu=true
elif [[ "$OS_ID" == "fedora" ]]; then
  is_rhel_like=true
elif [[ "$OS_ID" == "ol" || "$OS_ID" == "oracle" || "$OS_ID" == "oraclelinux" ]]; then
  is_rhel_like=true
elif [[ "$OS_LIKE" == *"rhel"* || "$OS_LIKE" == *"fedora"* ]]; then
  is_rhel_like=true
fi

if $is_ubuntu; then
  CONF="/etc/chrony/chrony.conf"
  SVC="chrony"
elif $is_rhel_like; then
  CONF="/etc/chrony.conf"
  SVC="chronyd"
else
  echo "Unsupported OS (need Ubuntu/Fedora/Oracle Linux 9.x)." >&2
  exit 1
fi

# --- Ask for server ---
DEFAULT_SERVER="172.20.240.89"
read -r -p "NTP server IP/hostname [${DEFAULT_SERVER}]: " NTP_SERVER
NTP_SERVER="${NTP_SERVER:-$DEFAULT_SERVER}"

if [[ -z "$NTP_SERVER" ]]; then
  echo "No server provided." >&2
  exit 1
fi

# --- Install chrony ---
echo "[*] Installing chrony..."
if command -v apt-get >/dev/null 2>&1; then
  export DEBIAN_FRONTEND=noninteractive
  apt-get update -y
  apt-get install -y chrony
elif command -v dnf >/dev/null 2>&1; then
  dnf install -y chrony
elif command -v yum >/dev/null 2>&1; then
  yum install -y chrony
else
  echo "No supported package manager found (apt/dnf/yum)." >&2
  exit 1
fi

# --- Backup + write config ---
BACKUP="${CONF}.bak.$(date +%Y%m%d%H%M%S)"
cp -a "$CONF" "$BACKUP" 2>/dev/null || true

echo "[*] Writing chrony client config: $CONF (backup: $BACKUP)"

cat > "$CONF" <<EOF
# Managed by chrony-ntp-client-setup.sh
# NTP client -> sync from your internal server
server ${NTP_SERVER} iburst

# Recommended client settings
driftfile /var/lib/chrony/chrony.drift
makestep 1.0 3
rtcsync
logdir /var/log/chrony
EOF

# --- Enable + restart ---
echo "[*] Enabling and restarting service: $SVC"
systemctl enable --now "$SVC"
systemctl restart "$SVC"

echo ""
echo "[+] Done. Quick checks:"
echo "    chronyc tracking"
echo "    chronyc sources -v"
echo ""
chronyc tracking || true
echo ""
chronyc sources -v || true
