#!/usr/bin/env bash
set -euo pipefail

# certpin-lite.sh
# -d : create baseline pins.json from embedded domains
# -c : check against pins.json

PINS_FILE="pins.json"

DOMAINS=(
  github.com
  deb.debian.org
  security.debian.org
  www.google.com
  www.chatgpt.com
  www.cloudflare.com
  archive.ubuntu.com
)

# --- colors ---
RED="\033[31m"; GRN="\033[32m"; YLW="\033[33m"; BLU="\033[34m"; CYN="\033[36m"; RST="\033[0m"
ok()    { echo -e "${GRN}$*${RST}"; }
warn()  { echo -e "${YLW}$*${RST}"; }
bad()   { echo -e "${RED}$*${RST}"; }
info()  { echo -e "${CYN}$*${RST}"; }

usage() {
  cat <<EOF
Usage:
  $0 -d    Create baseline pins.json from embedded domains
  $0 -c    Check current certificates against pins.json

Description:
  Lightweight TLS certificate pinning check using SHA256 fingerprints.
  Useful for detecting TLS interception / MITM.

Exit codes (check mode):
  0  OK
  1  Certificate changed (possible rotation/CDN)
  2  MITM suspected (corporate/inspection issuer)
EOF
  exit 1
}

ensure_tools() {
  command -v openssl >/dev/null || { bad "Missing: openssl"; exit 2; }
  command -v timeout >/dev/null || { bad "Missing: timeout (coreutils)"; exit 2; }
}

fetch_cert() {
  local d="$1"
  echo | timeout 8 openssl s_client -servername "$d" -connect "$d:443" 2>/dev/null \
  | openssl x509 -noout -fingerprint -sha256 -issuer -subject -enddate 2>/dev/null
}

issuer_looks_corp() {
  # add/remove keywords based on what you see in your environment
  echo "$1" | grep -Eqi \
    'zscaler|bluecoat|broadcom|palo alto|netskope|forcepoint|symantec|checkpoint|fortinet|sophos|cisco|umbrella|proxy|inspection|decrypt|gateway|firewall|corp|corporate'
}

create_baseline() {
  ensure_tools
  info "[*] Creating baseline pins.json"

  {
    echo "{"
    echo '  "generated_at": "'"$(date -u +"%Y-%m-%dT%H:%M:%SZ")"'",'
    echo '  "domains": {'
  } > "$PINS_FILE"

  first=1
  for d in "${DOMAINS[@]}"; do
    info "[*] $d"
    out="$(fetch_cert "$d")" || { warn "[!] fail $d (skip)"; continue; }

    fp="$(echo "$out" | sed -n 's/^sha256 Fingerprint=//p')"
    issuer="$(echo "$out" | sed -n 's/^issuer=//p')"
    subj="$(echo "$out" | sed -n 's/^subject=//p')"
    na="$(echo "$out" | sed -n 's/^notAfter=//p')"

    [ -n "$fp" ] || { warn "[!] no fp $d (skip)"; continue; }

    [ $first -eq 1 ] || echo "    ," >> "$PINS_FILE"
    first=0

    cat >> "$PINS_FILE" <<EOF
    "$d": {
      "allowed_sha256": ["$fp"],
      "last_seen": {
        "sha256": "$fp",
        "issuer": "$issuer",
        "subject": "$subj",
        "not_after": "$na"
      }
    }
EOF
  done

  echo "  }" >> "$PINS_FILE"
  echo "}" >> "$PINS_FILE"

  ok "[+] Baseline saved to $PINS_FILE"
}

check_pins() {
  ensure_tools
  [ -f "$PINS_FILE" ] || { bad "pins.json not found (run $0 -d first)"; exit 2; }

  rc=0

  for d in "${DOMAINS[@]}"; do
    echo -e "\n${BLU}==> $d${RST}"
    out="$(fetch_cert "$d")" || { bad "‚ùå FAIL (timeout/blocked)"; rc=$((rc==2?2:1)); continue; }

    fp="$(echo "$out" | sed -n 's/^sha256 Fingerprint=//p')"
    issuer="$(echo "$out" | sed -n 's/^issuer=//p')"
    na="$(echo "$out" | sed -n 's/^notAfter=//p')"

    echo "SHA256: $fp"
    echo "Issuer: $issuer"
    echo "NotAfter: $na"

    if grep -qF "$fp" "$PINS_FILE"; then
      ok "‚úÖ OK (matches baseline)"
      continue
    fi

    # Changed fingerprint
    if issuer_looks_corp "$issuer"; then
      bad "üö® MITM SUSPECTED (corporate/TLS inspection issuer)"
      bad "    -> Action: compare from a different network, or inspect system trust store / proxy settings."
      rc=2
    else
      warn "‚ö†Ô∏è  CHANGED (likely rotation/CDN). If expected, add this fp to allowed_sha256."
      rc=$((rc==2?2:1))
    fi
  done

  exit "$rc"
}

[ $# -eq 1 ] || usage
case "$1" in
  -d) create_baseline ;;
  -c) check_pins ;;
  *) usage ;;
esac