#!/usr/bin/env bash
set -euo pipefail

SSHA_DIR="$HOME/.ssha"
PORT=12345
OWNER_UID="${SUDO_UID:-$UID}"
SS_PID=""
RULE_ADDED=0

extract_server_field() {
  local cfg_path="$1"
  local key="$2"
  case "$key" in
    server)
      sed -n 's/.*"server"[[:space:]]*:[[:space:]]*"\([^"]*\)".*/\1/p' "$cfg_path" | head -n 1
      ;;
    server_port)
      sed -n 's/.*"server_port"[[:space:]]*:[[:space:]]*\([0-9]\+\).*/\1/p' "$cfg_path" | head -n 1
      ;;
  esac
}

check_server() {
  local server="$1"
  local port="$2"

  if command -v nc >/dev/null 2>&1; then
    nc -z -w 2 "$server" "$port" >/dev/null 2>&1
    return $?
  fi

  if command -v timeout >/dev/null 2>&1; then
    timeout 2 bash -c "echo > /dev/tcp/$server/$port" >/dev/null 2>&1
    return $?
  fi

  (echo >/dev/tcp/"$server"/"$port") >/dev/null 2>&1
  return $?
}

cleanup() {
  if (( RULE_ADDED )); then
    sudo iptables -t nat -D OUTPUT -p tcp --dport 443 -m owner --uid-owner "$OWNER_UID" -j REDIRECT --to-ports "$PORT" 2>/dev/null || true
  fi
  if [[ -n "$SS_PID" ]]; then
    kill "$SS_PID" 2>/dev/null || true
    wait "$SS_PID" 2>/dev/null || true
  fi
}
trap 'cleanup; exit 130' INT
trap 'cleanup' EXIT TERM

mapfile -t files < <(find "$SSHA_DIR" -maxdepth 1 -type f -name '*.json' -printf '%f\n' 2>/dev/null | sort)
(( ${#files[@]} )) || { echo "No hay archivos .json en $SSHA_DIR"; exit 1; }

echo "Elige una conexión:"
for i in "${!files[@]}"; do
  cfg_path="$SSHA_DIR/${files[i]}"
  server="$(extract_server_field "$cfg_path" "server")"
  port="$(extract_server_field "$cfg_path" "server_port")"
  if [ -n "${server:-}" ] && [ -n "${port:-}" ]; then
    if check_server "$server" "$port"; then
      status="\033[34m(online)\033[0m"
    else
      status="\033[31m(offline)\033[0m"
    fi
  else
    status="(unknown)"
  fi
  printf "%2d) %s %b\n" $((i+1)) "${files[i]}" "$status"
done

while true; do
  read -rp "Número (1-${#files[@]}): " sel || exit 130
  if [[ "$sel" =~ ^[0-9]+$ ]] && (( sel >= 1 && sel <= ${#files[@]} )); then
    CFG="$SSHA_DIR/${files[sel-1]}"
    break
  fi
  echo "Selección inválida."
done

sudo iptables -t nat -I OUTPUT -p tcp --dport 443 -m owner --uid-owner "$OWNER_UID" -j REDIRECT --to-ports "$PORT"
RULE_ADDED=1

ss-redir -c "$CFG" -l "$PORT" -u -v &
SS_PID=$!

trap 'kill -TERM "$SS_PID" 2>/dev/null; cleanup; exit 130' INT
wait "$SS_PID"
