#!/usr/bin/env bash

trap "echo -e '\n\e[1;31mAborted by user. Exiting...\e[0m'; exit" SIGINT

# Check for target
if [[ -z "$1" ]]; then
    echo "Usage: $0 target"
    echo "Example: $0 192.168.1.1"
    echo "Tip: Convert Nmap XML to HTML with xsltproc:"
    echo "Example: xsltproc scan.xml > scan.html"
    echo "Note: If it fails, install nmap's XSL or use the full path to nmap.xsl (e.g. /usr/share/nmap/nmap.xsl)."
    exit 1
fi

TARGET="$1"
SAFE_TARGET="${TARGET//[^a-zA-Z0-9._-]/_}"
OUTDIR="$(pwd)/${SAFE_TARGET}"

function check_dependencies() {
    local deps=("nmap")
    for dep in "${deps[@]}"; do
        if ! command -v "$dep" &>/dev/null; then
            echo -e "\e[1;31mMissing dependency:\e[0m $dep"
            read -p "Do you want to install $dep? (y/n): " choice
            if [[ "$choice" =~ ^[Yy]$ ]]; then
                sudo apt update
                sudo apt install "$dep" -y
            else
                echo -e "\e[1;31mCannot continue without $dep. Exiting...\e[0m"
                exit 1
            fi
        fi
    done
}

function slugify() {
    echo "$1" | tr '[:upper:]' '[:lower:]' | tr ' ' '_' | tr -cd 'a-z0-9_-'
}

function run_nmap() {
    local label="$1"
    shift
    local ts
    ts="$(date +%Y%m%d_%H%M%S)"
    local slug
    slug="$(slugify "$label")"
    local out="${OUTDIR}/${slug}_${ts}"
    echo -e "\e[1;31mnmap $* -oA $out\e[0m"
    nmap "$@" -oA "$out"
}

function show_header() {
    clear
    echo -e "\e[1;34m=========== ULTRA SCAN MENU ===========\e[0m"
    echo "Target: $TARGET"
    echo "Output folder: $OUTDIR"
}

check_dependencies
mkdir -p "$OUTDIR"

while true; do
    show_header

    echo -e "\e[1;32mSelect scan type:\e[0m"
   options=(
    $'\e[1;33m1.\e[0m  Ping Scan                [nmap -sn]'
    $'\e[1;33m2.\e[0m  TCP SYN Scan             [nmap -sS]'
    $'\e[1;33m3.\e[0m  UDP Scan                 [nmap -sU]'
    $'\e[1;33m4.\e[0m  OS Detection             [nmap -O]'
    $'\e[1;33m5.\e[0m  Version Detection        [nmap -sV]'
    $'\e[1;33m6.\e[0m  Aggressive Scan          [nmap -A]'
    $'\e[1;33m7.\e[0m  Fast Scan                [nmap -F]'
    $'\e[1;33m8.\e[0m  All Ports Scan           [nmap -p-]'
    $'\e[1;33m9.\e[0m  Top Ports Scan           [nmap --top-ports]'
    $'\e[1;33m10.\e[0m Firewall Evasion          [nmap -f]'
    $'\e[1;33m11.\e[0m Vulnerability Scan        [nmap --script vuln]'
    $'\e[1;33m12.\e[0m NSE Script Scan           [nmap --script default,vuln]'
    $'\e[1;33m13.\e[0m Decoy Scan                [nmap -D]'
    $'\e[1;33m14.\e[0m Traceroute                [nmap --traceroute]'
    $'\e[1;33m15.\e[0m Custom Ports              [nmap -p]'
    $'\e[1;33m16.\e[0m Output to File            [nmap -oA]'
    $'\e[1;33m17.\e[0m Spoof MAC                 [nmap --spoof-mac]'
    $'\e[1;33m18.\e[0m DNS Brute Force           [nmap --script dns-brute]'
    $'\e[1;33m19.\e[0m HTTP Title Enum           [nmap --script http-title]'
    $'\e[1;33m20.\e[0m SMB Enumeration           [nmap --script smb-*]'
    $'\e[1;33m21.\e[0m FTP Anonymous Check       [nmap --script ftp-anon]'
    $'\e[1;33m22.\e[0m SSL Certificate Info      [nmap --script ssl-cert]'
    $'\e[1;33m23.\e[0m Detect WAF                [nmap --script http-waf-detect]'
    $'\e[1;33m24.\e[0m HTTP Methods Check        [nmap --script http-methods]'
    $'\e[1;33m25.\e[0m Extract Robots.txt        [nmap --script http-robots.txt]'
    $'\e[1;33m26.\e[0m Whois Lookup              [nmap --script whois]'
    $'\e[1;33m27.\e[0m Run All Safe Scripts      [nmap --script safe]'
    $'\e[1;33m28.\e[0m Exit'

    )

    for opt in "${options[@]}"; do
        echo "$opt"
    done

    echo -ne "\nEnter option number: "
    read opt

    case $opt in
        1) run_nmap "Ping Scan" -sn "$TARGET" ;;
        2) run_nmap "TCP SYN Scan" -sS "$TARGET" ;;
        3) run_nmap "UDP Scan" -sU "$TARGET" ;;
        4) run_nmap "OS Detection" -O "$TARGET" ;;
        5) run_nmap "Version Detection" -sV "$TARGET" ;;
        6) run_nmap "Aggressive Scan" -A "$TARGET" ;;
        7) run_nmap "Fast Scan" -F "$TARGET" ;;
        8) run_nmap "All Ports Scan" -p- "$TARGET" ;;
        9) run_nmap "Top Ports Scan" --top-ports 100 "$TARGET" ;;
        10) run_nmap "Firewall Evasion" -f --data-length 200 "$TARGET" ;;
        11) run_nmap "Vulnerability Scan" --script vuln "$TARGET" ;;
        12) run_nmap "NSE Script Scan" --script default,vuln "$TARGET" ;;
        13) read -p "Enter decoy IP (or RND:10): " decoy
            run_nmap "Decoy Scan" -D "$decoy" "$TARGET" ;;
        14) run_nmap "Traceroute" --traceroute "$TARGET" ;;
        15) read -p "Enter ports (e.g. 21,22,80): " ports
            run_nmap "Custom Ports" -p "$ports" "$TARGET" ;;
        16) read -p "Output filename (no extension): " filename
            ts="$(date +%Y%m%d_%H%M%S)"
            out="${OUTDIR}/${filename}_${ts}"
            echo -e "\e[1;31mnmap -A $TARGET -oA $out\e[0m"
            nmap -A "$TARGET" -oA "$out" ;;
        17) read -p "Enter MAC type (e.g. 0=random): " mac
            run_nmap "Spoof MAC" --spoof-mac "$mac" "$TARGET" ;;
        18) run_nmap "DNS Brute Force" --script dns-brute "$TARGET" ;;
        19) run_nmap "HTTP Title Enum" --script http-title "$TARGET" ;;
        20) run_nmap "SMB Enumeration" --script smb-enum-shares,smb-enum-users "$TARGET" ;;
        21) run_nmap "FTP Anonymous Check" --script ftp-anon "$TARGET" ;;
        22) run_nmap "SSL Certificate Info" --script ssl-cert "$TARGET" ;;
        23) run_nmap "Detect WAF" --script http-waf-detect "$TARGET" ;;
        24) run_nmap "HTTP Methods Check" --script http-methods "$TARGET" ;;
        25) run_nmap "Extract Robots.txt" --script http-robots.txt "$TARGET" ;;
        26) run_nmap "Whois Lookup" --script whois "$TARGET" ;;
        27) run_nmap "Run All Safe Scripts" --script safe "$TARGET" ;;
        28) echo -e "\n\e[1;31mExiting Ultra Scan... Goodbye!\e[0m"
            exit 0 ;;
        *) echo -e "\e[1;31mInvalid option. Try again.\e[0m" ;;
    esac

    echo -e "\nPress ENTER to return to menu..."
    read
done
