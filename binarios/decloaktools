#!/usr/bin/env bash
set -euo pipefail

# Colors
CYAN='\033[1;36m'
BLUE='\033[1;34m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
RED='\033[1;31m'
NC='\033[0m'

SCRIPT_NAME="$(basename "$0")"

print_tools() {
  echo -e "${CYAN}------------------------------------------------------------${NC}"
  echo -e "${CYAN}Post-Scan Examination Guidance${NC}"
  echo -e "${CYAN}------------------------------------------------------------${NC}"
  cat <<'EOF'

The following tools can be used to further examine suspicious findings:

1) Verify file type and behavior
   - ls -l <file>
   - stat <file>
   - file <file>

2) Compare against expected system sources
   - cat <file>
   - Compare with known equivalents (e.g. /proc/self/* for virtual files)

3) Check for preload or userland hooks
   - cat /etc/ld.so.preload
   - env | grep LD_PRELOAD

4) Check for kernel-level manipulation
   - lsmod
   - dmesg | tail
   - uname -a

5) Cross-check process visibility (if applicable)
   - ps aux
   - ss -lntup
   - Compare with alternative tools (procfs, netstat)

What to look for:
- Size mismatches on static configuration files
- Content visible via mmap but hidden via standard tools
- Unexpected symlinks or redirections
- Files that should be static but change during read

Note:
Dynamic or virtual files (e.g. /proc, /sys, /etc/mtab) may produce false positives.

EOF
  echo -e "${CYAN}------------------------------------------------------------${NC}"
}

usage() {
  echo -e "${BLUE}4rji Decloak Diff Utility${NC} (standard read vs mmap read)"
  echo
  echo -e "${YELLOW}Usage:${NC}"
  echo -e "  ${GREEN}./${SCRIPT_NAME} <file>${NC}"
  echo
  echo -e "${YELLOW}Examples:${NC}"
  echo -e "  ${GREEN}./${SCRIPT_NAME} /etc/passwd${NC}"
  echo -e "  ${GREEN}./${SCRIPT_NAME} /etc/ld.so.preload${NC}"
  echo
}

run_diff() {
  local target="$1"

  if ! command -v python3 >/dev/null 2>&1; then
    echo -e "${RED}Error:${NC} python3 not found (needed for mmap read)."
    exit 2
  fi

  if [[ ! -e "$target" ]]; then
    echo -e "${RED}Error:${NC} file not found: $target"
    exit 2
  fi

  if [[ -d "$target" ]]; then
    echo -e "${RED}Error:${NC} target is a directory (this script expects a single file)."
    exit 2
  fi

  local ts outdir out_std out_mmap
  ts="$(date +%Y%m%d_%H%M%S)"
  outdir="${HOME}/ESCANEO_${ts}"
  mkdir -p "$outdir"

  out_std="${outdir}/standard.txt"
  out_mmap="${outdir}/mmap.txt"

  echo -e "${BLUE}\n=== Target ===${NC}"
  echo -e "${GREEN}${target}${NC}"
  echo -e "${BLUE}\n=== Output dir ===${NC}"
  echo -e "${GREEN}${outdir}${NC}"

  # Standard read (what normal tools see)
  # Use cat -A to make hidden chars visible-ish in output, but keep it simple/plain:
  cat -- "$target" >"$out_std" 2>/dev/null || true

  # MMAP read (may bypass some userland hooks)
  python3 - "$target" >"$out_mmap" <<'PY'
import sys, mmap, binascii, os
path = sys.argv[1]
try:
    with open(path, "rb") as f:
        st = os.fstat(f.fileno())
        if st.st_size == 0:
            sys.exit(0)
        mm = mmap.mmap(f.fileno(), 0, access=mmap.PROT_READ)
        try:
            # print line by line; non-utf8 -> hex line
            seek = 0
            while seek < mm.size():
                b = mm.readline()
                seek += len(b)
                try:
                    sys.stdout.write(b.decode("utf-8"))
                except UnicodeDecodeError:
                    sys.stdout.write("hex: " + binascii.hexlify(b).decode() + "\n")
        finally:
            mm.close()
except Exception as e:
    sys.stderr.write(f"mmap error: {e}\n")
    sys.exit(2)
PY

  echo -e "${BLUE}\n=== Sizes ===${NC}"
  local s1 s2
  s1="$(wc -c <"$out_std" | tr -d ' ')"
  s2="$(wc -c <"$out_mmap" | tr -d ' ')"
  echo -e "${GREEN}standard:${NC} ${s1} bytes"
  echo -e "${GREEN}mmap:    ${NC} ${s2} bytes"

  echo -e "${BLUE}\n=== Diff (standard vs mmap) ===${NC}"
  # If files are identical -> no output; so show a friendly line
  if diff -u --label "standard" --label "mmap" "$out_std" "$out_mmap"; then
    echo -e "${GREEN}No differences detected.${NC}"
  else
    echo -e "${YELLOW}Differences detected (review above).${NC}"
  fi

  echo -e "${BLUE}\n=== Saved files ===${NC}"
  echo -e "${GREEN}${out_std}${NC}"
  echo -e "${GREEN}${out_mmap}${NC}"
}

main() {
  if [[ $# -eq 0 ]]; then
    usage
    print_tools
    exit 0
  fi

  if [[ $# -ne 1 ]]; then
    usage
    exit 1
  fi

  run_diff "$1"
  print_tools
}

main "$@"
