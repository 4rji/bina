#!/usr/bin/env bash

backup_file="/etc/sysctl.conf.bak"
sysctl_file="/etc/sysctl.conf"

# Verificar si se usa la opción -b para restaurar el backup
if [[ "$1" == "-b" ]]; then
    if [[ -f "$backup_file" ]]; then
        echo "Restaurando backup de $sysctl_file..."
        sudo cp "$backup_file" "$sysctl_file"
        sudo sysctl --system
        echo "Backup restaurado y configuraciones recargadas."
    else
        echo "No se encontró un archivo de backup en $backup_file."
    fi
    exit 0
fi

# Crear un backup del archivo sysctl.conf
echo "Creando backup de $sysctl_file..."
sudo cp "$sysctl_file" "$backup_file"
echo "Backup creado en $backup_file."

# Líneas a agregar (con todas las que solicitaste, incluyendo duplicados)
lines_to_add="
net.ipv4.ip_forward = 0
net.ipv4.conf.all.send_redirects = 0
net.ipv4.conf.default.send_redirects = 0
net.ipv4.conf.all.accept_redirects = 0
net.ipv4.conf.default.accept_redirects = 0
net.ipv4.icmp_ignore_bogus_error_responses = 1
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1

net.ipv4.conf.all.accept_source_route=0
ipv4.conf.all.forwarding=0
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1
net.ipv4.conf.all.accept_redirects=0
net.ipv4.conf.all.secure_redirects=0
net.ipv4.conf.all.send_redirects=0
net.ipv4.conf.all.rp_filter=2
net.ipv4.icmp_echo_ignore_all = 0
"

# Añadir líneas al final de /etc/sysctl.conf
echo "$lines_to_add" | sudo tee -a "$sysctl_file"

# Preguntar si se desean reiniciar las variables de sysctl
echo ""
read -p "¿Deseas reiniciar las variables de sysctl ahora? (y/n): " answer

if [[ "$answer" == "y" ]]; then
    # Reiniciar las variables de sysctl
    sudo sysctl --system
    echo "Variables de sysctl reiniciadas."
else
    echo "No se reiniciaron las variables de sysctl. Puedes reiniciarlas manualmente ejecutando 'sudo sysctl --system'."
fi