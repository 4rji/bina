#!/usr/bin/env bash
# tun2.sh
# Policy routing via tun0 ONLY for your user, but EXCLUDES SSH (TCP/22) to avoid killing the session.

set -euo pipefail

TABLE=100
MARK=1
DEV="tun0"
TUN_ADDR="10.0.0.1/24"
UID_ME="$(id -u)"
CHAIN="TUN2SOCKS_MARK"

# Function to show messages
echo_msg() {
  echo ""
  echo -e "\033[36m==============================================\033[0m"
  echo -e "$1"
  echo -e "\033[36m==============================================\033[0m"
  echo ""
  echo -e "\033[35m_________________________________________________________\033[0m"
  echo ""
}

usage() {
  echo_msg "\033[34mUSAGE\033[0m"

  echo -e "\033[33m  ./tun2.sh -t     Create/bring up tun0 (tuntap + addr + up)\033[0m"
  echo -e "\033[33m  ./tun2.sh -a     Add (enable) policy routing to tun0 for your user\033[0m"
  echo -e "\033[33m  ./tun2.sh -r     Remove (disable) the rules\033[0m"
  echo -e "\033[33m  ./tun2.sh -s     Show current state\033[0m"
  echo -e "\033[33m  ./tun2.sh -x     Execute tun2socks tunnel\033[0m"

  echo ""
  echo -e "\033[34mFLAGS\033[0m"
  echo ""
  echo -e "\033[32m  -t  Runs:\033[0m"
  echo -e "\033[32m      sudo ip tuntap add dev tun0 mode tun\033[0m"
  echo -e "\033[32m      sudo ip addr add 10.0.0.1/24 dev tun0\033[0m"
  echo -e "\033[32m      sudo ip link set tun0 up\033[0m"

  echo ""
  echo -e "\033[36m  -a  Adds:\033[0m"
  echo -e "\033[36m      1) ip route ... table 100     -> default route in table 100 goes to tun0\033[0m"
  echo -e "\033[36m      2) ip rule fwmark 1 table 100 -> packets marked with 1 use table 100\033[0m"
  echo -e "\033[36m      3) iptables mangle OUTPUT     -> marks ONLY your UID traffic (except SSH tcp/22)\033[0m"

  echo ""
  echo -e "\033[35m  -r  Removes the above (iptables chain/hook, ip rule, and table 100 routes)\033[0m"

  echo ""
  echo -e "\033[34m  -s  Shows:\033[0m"
  echo -e "\033[34m      ip rule + table 100 routes + mangle OUTPUT rules\033[0m"
  echo ""
  echo -e "\033[33m      now start:\033[0m"
  echo ""
  echo -e "\033[33m      tun2socks --device tun://tun0 --proxy socks5://127.0.0.1:1080\033[0m"
  echo ""

  echo -e "\033[32m  -x  Runs:\033[0m"
  echo -e "\033[32m      tun2socks --device tun://tun0 --proxy socks5://127.0.0.1:1080\033[0m"
  echo ""
}

ensure_chain() {
  # Create chain if missing
  sudo iptables -t mangle -N "$CHAIN" 2>/dev/null || true

  # Hook OUTPUT -> CHAIN once
  sudo iptables -t mangle -C OUTPUT -j "$CHAIN" 2>/dev/null \
    || sudo iptables -t mangle -A OUTPUT -j "$CHAIN"

  # Rules inside chain:
  # 1) Don't touch localhost traffic
  sudo iptables -t mangle -C "$CHAIN" -d 127.0.0.0/8 -j RETURN 2>/dev/null \
    || sudo iptables -t mangle -A "$CHAIN" -d 127.0.0.0/8 -j RETURN

  # 2) Don't mark SSH so you don't lose the session
  sudo iptables -t mangle -C "$CHAIN" -p tcp --dport 22 -j RETURN 2>/dev/null \
    || sudo iptables -t mangle -A "$CHAIN" -p tcp --dport 22 -j RETURN

  # 3) Mark ONLY your user's traffic
  sudo iptables -t mangle -C "$CHAIN" -m owner --uid-owner "$UID_ME" -j MARK --set-mark "$MARK" 2>/dev/null \
    || sudo iptables -t mangle -A "$CHAIN" -m owner --uid-owner "$UID_ME" -j MARK --set-mark "$MARK"
}

tun_setup() {
  # 1) Create tun0 if missing
  if ! ip link show "$DEV" >/dev/null 2>&1; then
    sudo ip tuntap add dev "$DEV" mode tun
  fi

  # 2) Add addr if missing
  if ! ip -4 addr show dev "$DEV" | grep -qE "\b${TUN_ADDR%/*}\/"; then
    sudo ip addr add "$TUN_ADDR" dev "$DEV"
  fi

  # 3) Bring it up
  sudo ip link set "$DEV" up

  echo_msg "\033[32m[+] tun setup: $DEV up with $TUN_ADDR\033[0m"
}

add_rules() {
  sudo ip route replace default dev "$DEV" table "$TABLE"
  sudo ip rule add fwmark "$MARK" table "$TABLE" 2>/dev/null || true
  ensure_chain

  echo_msg "\033[36m[+] Enabled: fwmark=$MARK -> table=$TABLE default via $DEV (only UID=$UID_ME, SSH tcp/22 excluded)\033[0m"
}

remove_rules() {
  # Unhook and delete chain/rules (best-effort)
  sudo iptables -t mangle -D OUTPUT -j "$CHAIN" 2>/dev/null || true
  sudo iptables -t mangle -F "$CHAIN" 2>/dev/null || true
  sudo iptables -t mangle -X "$CHAIN" 2>/dev/null || true

  sudo ip rule del fwmark "$MARK" table "$TABLE" 2>/dev/null || true
  sudo ip route flush table "$TABLE" 2>/dev/null || true

  echo_msg "\033[33m[-] Disabled: removed ip rule, flushed table $TABLE, removed iptables chain $CHAIN\033[0m"
}

show_state() {
  echo_msg "\033[34m== tun device ==\033[0m"
  ip -d link show "$DEV" 2>/dev/null || echo -e "\033[31m(no $DEV)\033[0m"
  ip -4 addr show dev "$DEV" 2>/dev/null || true

  echo_msg "\033[35m== ip rule ==\033[0m"
  ip rule || true

  echo_msg "\033[34m== table $TABLE ==\033[0m"
  ip route show table "$TABLE" || true

  echo_msg "\033[36m== iptables mangle OUTPUT ==\033[0m"
  sudo iptables -t mangle -S OUTPUT || true

  echo_msg "\033[33m== chain $CHAIN (if exists) ==\033[0m"
  sudo iptables -t mangle -S "$CHAIN" 2>/dev/null || echo -e "\033[31m(chain not present)\033[0m"
}

run_tunnel() {
  echo_msg "\033[32m[>] Starting: tun2socks --device tun://tun0 --proxy socks5://127.0.0.1:1080\033[0m"
  tun2socks --device tun://tun0 --proxy socks5://127.0.0.1:1080
}

case "${1:-}" in
  -t) tun_setup ;;
  -a) add_rules ;;
  -r) remove_rules ;;
  -s) show_state ;;
  -x) run_tunnel ;;
  -h|--help|"") usage ;;
  *) echo_msg "\033[31mUnknown flag: $1\033[0m"; usage; exit 1 ;;
esac