#!/usr/bin/env bash
set -euo pipefail

need_root() { [[ "${EUID:-$(id -u)}" -eq 0 ]] || { echo "Run as root"; exit 1; }; }
stamp() { date +"%Y%m%d-%H%M%S"; }
bk() { local f="$1"; [[ -f "$f" ]] && cp -a "$f" "$f.bak.$(stamp)"; }
has() { command -v "$1" >/dev/null 2>&1; }

os_family() {
  . /etc/os-release 2>/dev/null || true
  case "${ID_LIKE:-$ID}" in
    *rhel*|*fedora*|*centos*|*rocky*|*almalinux*) echo "rhel" ;;
    *debian*|*ubuntu*) echo "debian" ;;
    *) echo "unknown" ;;
  esac
}

ensure_kv_conf() {
  # key value in a conf file: key=value (or key value)
  local file="$1" key="$2" value="$3" sep="${4:-=}"
  [[ -f "$file" ]] || { mkdir -p "$(dirname "$file")"; touch "$file"; }
  bk "$file"
  if grep -Eq "^[[:space:]]*${key}[[:space:]]*${sep}" "$file"; then
    sed -ri "s|^[[:space:]]*${key}[[:space:]]*${sep}.*|${key}${sep}${value}|g" "$file"
  else
    printf "%s%s%s\n" "$key" "$sep" "$value" >> "$file"
  fi
}

ensure_line_once() {
  local file="$1" line="$2"
  [[ -f "$file" ]] || { mkdir -p "$(dirname "$file")"; touch "$file"; }
  bk "$file"
  grep -Fxq "$line" "$file" || printf "%s\n" "$line" >> "$file"
}

human_users() {
  # UID>=1000 and <60000, not nologin/false
  awk -F: '($3>=1000 && $3<60000) && ($7 !~ /(\/usr\/sbin\/nologin|\/sbin\/nologin|\/bin\/false)/){print $1}' /etc/passwd
}

apply_login_defs() {
  local f="/etc/login.defs"
  [[ -f "$f" ]] || return 0
  bk "$f"
  # 5) max 90 days, 8) min age 1 day (for humans we also set via chage), 9) no reversible -> strong hash method
  if grep -Eq '^[[:space:]]*PASS_MAX_DAYS' "$f"; then
    sed -ri 's/^[[:space:]]*PASS_MAX_DAYS[[:space:]]+.*/PASS_MAX_DAYS   90/g' "$f"
  else
    echo "PASS_MAX_DAYS   90" >> "$f"
  fi
  if grep -Eq '^[[:space:]]*PASS_MIN_DAYS' "$f"; then
    sed -ri 's/^[[:space:]]*PASS_MIN_DAYS[[:space:]]+.*/PASS_MIN_DAYS   1/g' "$f"
  else
    echo "PASS_MIN_DAYS   1" >> "$f"
  fi
  if grep -Eq '^[[:space:]]*ENCRYPT_METHOD' "$f"; then
    sed -ri 's/^[[:space:]]*ENCRYPT_METHOD[[:space:]]+.*/ENCRYPT_METHOD SHA512/g' "$f"
  else
    echo "ENCRYPT_METHOD SHA512" >> "$f"
  fi
}

apply_pwquality() {
  local f="/etc/security/pwquality.conf"
  [[ -f "$f" ]] || { mkdir -p /etc/security; touch "$f"; }
  bk "$f"
  # 1) 4 types, 2) minlen 15, 10/11) complexity enabled via pwquality
  ensure_kv_conf "$f" "minlen" "15" "="
  ensure_kv_conf "$f" "ucredit" "-1" "="
  ensure_kv_conf "$f" "lcredit" "-1" "="
  ensure_kv_conf "$f" "dcredit" "-1" "="
  ensure_kv_conf "$f" "ocredit" "-1" "="
  ensure_kv_conf "$f" "minclass" "4" "="
  ensure_kv_conf "$f" "maxrepeat" "3" "="
  ensure_kv_conf "$f" "gecoscheck" "1" "="
  ensure_kv_conf "$f" "dictcheck" "1" "="
}

apply_faillock_conf() {
  local f="/etc/security/faillock.conf"
  [[ -f "$f" ]] || { mkdir -p /etc/security; touch "$f"; }
  bk "$f"
  # 3) deny 5 in 15 min (900s), 4) lockout 15 min (900s)
  ensure_kv_conf "$f" "deny" "5" "="
  ensure_kv_conf "$f" "fail_interval" "900" "="
  ensure_kv_conf "$f" "unlock_time" "900" "="
}

apply_kerberos_clockskew() {
  local f="/etc/krb5.conf"
  [[ -f "$f" ]] || return 0
  bk "$f"
  # 11) time tolerance 5 minutes => clockskew = 300
  if grep -Eq '^[[:space:]]*clockskew[[:space:]]*=' "$f"; then
    sed -ri 's/^[[:space:]]*clockskew[[:space:]]*=.*/    clockskew = 300/g' "$f"
    return 0
  fi
  if grep -Eq '^\[libdefaults\]' "$f"; then
    awk '
      BEGIN{done=0}
      /^\[libdefaults\]/{print; in=1; next}
      in==1 && done==0 && /^\[/{print "    clockskew = 300"; done=1; in=0}
      {print}
      END{ if(in==1 && done==0){print "    clockskew = 300"} }
    ' "$f" > "${f}.tmp" && mv "${f}.tmp" "$f"
  else
    printf "\n[libdefaults]\n    clockskew = 300\n" >> "$f"
  fi
}

debian_pam() {
  # common-password: pwquality + history
  local cp="/etc/pam.d/common-password"
  local ca="/etc/pam.d/common-auth"
  local cc="/etc/pam.d/common-account"

  bk "$cp"; bk "$ca"; bk "$cc"

  # pwquality
  if ! grep -Eq 'pam_pwquality\.so' "$cp"; then
    sed -ri 's|^password\s+requisite\s+pam_cracklib\.so.*|password requisite pam_pwquality.so retry=3|' "$cp" 2>/dev/null || true
    grep -Eq '^password\s+requisite\s+pam_pwquality\.so' "$cp" || \
      sed -i '1ipassword requisite pam_pwquality.so retry=3' "$cp"
  fi

  # pwhistory remember=3 (7 "no hints" not applicable in PAM; 6 is history)
  if ! grep -Eq 'pam_pwhistory\.so' "$cp"; then
    # Insert before pam_unix if present
    if grep -Eq '^password\s+\[success=.*\]\s+pam_unix\.so' "$cp"; then
      sed -ri 's|^(password\s+\[success=.*\]\s+pam_unix\.so.*)$|password required pam_pwhistory.so remember=3 use_authtok\n\1|' "$cp"
    else
      echo 'password required pam_pwhistory.so remember=3 use_authtok' >> "$cp"
    fi
  else
    sed -ri 's/(pam_pwhistory\.so.*)(remember=)[0-9]+/\1remember=3/' "$cp" || true
    grep -Eq 'pam_pwhistory\.so.*remember=3' "$cp" || sed -ri 's/(pam_pwhistory\.so.*)/\1 remember=3/' "$cp"
  fi

  # faillock: best-effort (Ubuntu 22+/Debian 12+ usually have it)
  if has pam-auth-update || true; then
    # Add lines only if pam_faillock exists on system
    if [[ -f /lib/x86_64-linux-gnu/security/pam_faillock.so || -f /lib/security/pam_faillock.so ]]; then
      # auth: preauth + authfail
      grep -Eq 'pam_faillock\.so.*preauth' "$ca" || \
        sed -i '1iauth required pam_faillock.so preauth silent deny=5 fail_interval=900 unlock_time=900' "$ca"
      grep -Eq 'pam_faillock\.so.*authfail' "$ca" || \
        echo 'auth [default=die] pam_faillock.so authfail deny=5 fail_interval=900 unlock_time=900' >> "$ca"

      # account: required
      grep -Eq '^account\s+required\s+pam_faillock\.so' "$cc" || \
        echo 'account required pam_faillock.so' >> "$cc"
    fi
  fi
}

rhel_authselect() {
  # Use authselect features so updates persist
  if ! has authselect; then
    echo "authselect not found; skipping rhel PAM automation"
    return 0
  fi

  authselect current >/dev/null 2>&1 || authselect select minimal --force >/dev/null

  authselect enable-feature with-faillock >/dev/null 2>&1 || true
  authselect enable-feature with-pwhistory >/dev/null 2>&1 || true
  authselect apply-changes >/dev/null 2>&1 || true

  apply_faillock_conf
  apply_pwquality

  # Ensure pwhistory remembers 3
  # Paths depend on profile; patch both if present
  for f in /etc/pam.d/system-auth /etc/pam.d/password-auth; do
    [[ -f "$f" ]] || continue
    bk "$f"
    if grep -Eq 'pam_pwhistory\.so' "$f"; then
      sed -ri 's/(pam_pwhistory\.so.*)(remember=)[0-9]+/\1remember=3/' "$f" || true
      grep -Eq 'pam_pwhistory\.so.*remember=3' "$f" || sed -ri 's/(pam_pwhistory\.so.*)/\1 remember=3/' "$f"
    fi
  done

  # Ensure sha512 (no reversible encryption; strong hash)
  for f in /etc/pam.d/system-auth /etc/pam.d/password-auth; do
    [[ -f "$f" ]] || continue
    if grep -Eq 'pam_unix\.so' "$f"; then
      sed -ri 's/pam_unix\.so([^#\n]*)/pam_unix.so\1 sha512/g' "$f" || true
      # remove md5 if present
      sed -ri 's/\bmd5\b//g' "$f" || true
    fi
  done
}

apply_chage_humans() {
  while IFS= read -r u; do
    chage -M 90 "$u" 2>/dev/null || true
    chage -m 1  "$u" 2>/dev/null || true
  done < <(human_users)
}

main() {
  need_root
  local fam
  fam="$(os_family)"

  apply_login_defs
  apply_pwquality
  apply_kerberos_clockskew

  case "$fam" in
    debian)
      apply_faillock_conf
      debian_pam
      ;;
    rhel)
      rhel_authselect
      ;;
    *)
      echo "Unsupported OS family (edit manually): $fam"
      ;;
  esac

  apply_chage_humans

  echo "OK: pwquality(minlen=15, 4 classes), history(remember=3), lockout(deny=5/15m, unlock=15m), maxdays=90, mindays=1(humans), sha512, krb5 clockskew=300"
}

main "$@"
