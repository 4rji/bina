#!/usr/bin/env bash
set -euo pipefail

REPO_DIR="/home/nala/ArchStrike"
REPO_URL="https://github.com/ArchStrike/ArchStrike.git"

q="${1:-}"
if [[ -z "$q" ]]; then
  echo "Uso: $0 <busqueda>"
  exit 1
fi

# Clone si no existe
if [[ ! -d "$REPO_DIR/.git" ]]; then
  echo "[*] Repo no existe, clonando..."
  git clone "$REPO_URL" "$REPO_DIR"
fi

BASE="$REPO_DIR/archstrike"

echo "[*] Buscando: $q"
mapfile -t matches < <(
  find "$BASE" -maxdepth 2 -mindepth 1 -type d -iname "*$q*" -printf "%P\n" | sort
)

if (( ${#matches[@]} == 0 )); then
  echo "[-] No hay coincidencias"
  exit 2
fi

echo
echo "Resultados:"
for i in "${!matches[@]}"; do
  printf " [%d] %s\n" "$((i+1))" "${matches[$i]}"
done
echo

read -r -p "Elige nÃºmero (Enter = cancelar): " choice
[[ -z "${choice:-}" ]] && exit 0

idx=$((choice-1))
target_rel="${matches[$idx]}"
target="$BASE/$target_rel"

if [[ ! -f "$target/PKGBUILD" ]]; then
  echo "[-] No es un paquete vÃ¡lido (sin PKGBUILD)"
  exit 3
fi

pkgname=$(source "$target/PKGBUILD"; echo "$pkgname")

# ðŸ” Verificar si ya estÃ¡ instalado
if pacman -Qi "$pkgname" &>/dev/null; then
  echo "[âœ“] '$pkgname' ya estÃ¡ instalado"
  exit 0
fi

echo
echo "[*] Paquete: $pkgname"
read -r -p "Â¿Instalarlo? [y/N]: " yn
case "${yn,,}" in
  y|yes)
    cd "$target"
    makepkg -si
    ;;
  *)
    echo "[*] Cancelado"
    ;;
esac
