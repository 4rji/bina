#!/usr/bin/env bash

#requiere el
# descargar y nombrar Docker : Dockerfile-firefox-completo-afirec
#   ❯  docker build -t firefox-completo .
# firefox-completo:latest    e1c848fa25f5        1.4GB          366MB


set -e

# ---------- config ----------
PORT=8080
CONTAINER_NAME="searxng"
SEARXNG_STARTED=0
# ----------------------------

# ---------- arranca SearXNG con host ----------
docker image inspect searxng/searxng >/dev/null 2>&1 || docker pull searxng/searxng

if ! docker ps --format '{{.Names}}' | grep -qw "$CONTAINER_NAME"; then
  mkdir -p searxng
  docker run -d --rm \
    --name "$CONTAINER_NAME" \
    --network host \
    -p "${PORT}:8080" \
    -v "${PWD}/searxng:/etc/searxng" \
    -e "BASE_URL=http://localhost:${PORT}/" \
    searxng/searxng >/dev/null
  SEARXNG_STARTED=1
fi
# -----------------------------------------------

# ---------- idioma ----------
LANG_CODES=( "en-US" "es-ES" "ja" "zh-CN" "ru" "fr-FR" "de-DE" "pt-BR" "it-IT" "ko" )
LANG_NAMES=( "English" "Español" "日本語" "中文(简)" "Русский" "Français" "Deutsch" "Português(BR)" "Italiano" "한국어" )

echo; echo "Selecciona idioma:"
for i in "${!LANG_CODES[@]}"; do printf "  %02d) %-7s - %s\n" $((i+1)) "${LANG_CODES[$i]}" "${LANG_NAMES[$i]}"; done
read -rp "Número: " choice
idx=$((choice-1)); LANG="${LANG_CODES[$idx]}"
[ -z "$LANG" ] && { echo "Selección inválida"; [[ $SEARXNG_STARTED -eq 1 ]] && docker stop "$CONTAINER_NAME" >/dev/null; exit 1; }
# ----------------------------

# ---------- perfil efímero ----------
PROFILE=$(mktemp -d /tmp/fx-profile-XXXXXX)
trap '[[ $SEARXNG_STARTED -eq 1 ]] && docker stop "$CONTAINER_NAME" >/dev/null; rm -rf "$PROFILE"' EXIT

# arkenfox user.js base
curl -sSL https://raw.githubusercontent.com/arkenfox/user.js/master/user.js -o "$PROFILE/user.js"

# preferencias extra (fingerprint hardening)
cat >> "$PROFILE/user.js" <<EOF
user_pref("intl.accept_languages", "$LANG,en");
user_pref("general.useragent.locale", "$LANG");
user_pref("intl.locale.requested", "$LANG");
user_pref("privacy.resistFingerprinting", true);
user_pref("privacy.resistFingerprinting.randomization.enabled", true);
user_pref("canvas.transferFromImageBitmap.enabled", false);
user_pref("webgl.disabled", true);
user_pref("webgl.enable-webgl2", false);
user_pref("dom.maxHardwareConcurrency", 8);
user_pref("general.userAgent.override", "Mozilla/5.0 (X11; Linux x86_64; rv:128.0) Gecko/20100101 Firefox/128.0");
user_pref("general.oscpu.override", "Linux x86_64");
user_pref("ui.systemUsesDarkTheme", 1);
user_pref("layout.css.prefers-color-scheme.content-override", 2);
user_pref("browser.theme.content-theme", 2);
user_pref("browser.theme.toolbar-theme", 2);
user_pref("extensions.activeThemeID", "firefox-compact-dark@mozilla.org");
EOF

# CanvasBlocker
mkdir -p "$PROFILE/extensions"
curl -sSL https://addons.mozilla.org/firefox/downloads/file/4145310/canvasblocker-1.14.3-an+fx.xpi \
     -o "$PROFILE/extensions/canvasblocker@canvasblocker.xpi"
# ------------------------------------

xhost +local:docker

docker run \
  --network host \
  -e DISPLAY="$DISPLAY" \
  -v /tmp/.X11-unix:/tmp/.X11-unix \
  -v "$PROFILE":/home/user/.mozilla/firefox/default-release \
  --rm firefox-completo \
  -profile /home/user/.mozilla/firefox/default-release \
  "https://coveryourtracks.eff.org/" \
  "https://mullvad.net/en/check/" \
  "https://www.whatsmybrowser.org/" \
  "http://localhost:${PORT}"
