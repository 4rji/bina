#!/usr/bin/env bash
set -euo pipefail


# Lista de paquetes a instalar
paquetes=("git" "make" "g++" "iptables" "cmake")

# Función para verificar si un paquete está instalado (Debian/Ubuntu/Kali)
paquete_instalado_apt() {
    dpkg -l "$1" | grep -q '^ii'  
}

# Función para verificar si un paquete está instalado (CentOS/RHEL)
paquete_instalado_yum() {
    yum list installed "$1" &> /dev/null
}

# Función para verificar si un paquete está instalado (Fedora)
paquete_instalado_dnf() {
    dnf list installed "$1" &> /dev/null
}

# Función para verificar si un paquete está instalado (Arch Linux)
paquete_instalado_pacman() {
    pacman -Qi "$1" &> /dev/null
}

# Detectar el sistema operativo
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$ID
fi

# Instalar paquetes basados en el sistema operativo
for paquete in "${paquetes[@]}"; do
    case $OS in
        "debian"|"ubuntu"|"kali")
            if ! paquete_instalado_apt "$paquete"; then
                echo "Instalando el paquete $paquete..."
                sudo apt-get install -y "$paquete"
            fi
            ;;
        "centos"|"rhel")
            if ! paquete_instalado_yum "$paquete"; then
                echo "Instalando el paquete $paquete..."
                sudo yum install -y "$paquete"
            fi
            ;;
        "fedora")
            if ! paquete_instalado_dnf "$paquete"; then
                echo "Instalando el paquete $paquete..."
                sudo dnf install -y "$paquete"
            fi
            ;;
        "arch")
            if ! paquete_instalado_pacman "$paquete"; then
                echo "Instalando el paquete $paquete..."
                sudo pacman -S --noconfirm "$paquete"
            fi
            ;;
        *)
            ;;
    esac
done


# Deps (Fedora)
sudo dnf install -y git cmake make gcc gcc-c++ iptables wget

# Build/install Portspoof (idempotent)
if [[ -d portspoof/.git ]]; then
  git -C portspoof fetch --all --prune
  git -C portspoof reset --hard origin/master 2>/dev/null || true
  git -C portspoof reset --hard origin/main 2>/dev/null || true
else
  rm -rf portspoof
  git clone https://github.com/drk1wi/portspoof.git
fi

pushd portspoof >/dev/null
mkdir -p build
pushd build >/dev/null

cmake -DCMAKE_INSTALL_SYSCONFDIR=/etc ..
make -j"$(nproc)"
sudo make install

popd >/dev/null
popd >/dev/null

# Config files
sudo mkdir -p /etc/portspoof

sudo wget -qO /etc/portspoof/portspoof.conf \
  https://raw.githubusercontent.com/drk1wi/Portspoof/master/tools/portspoof.conf

sudo wget -qO /etc/portspoof/portspoof_signatures \
  https://raw.githubusercontent.com/drk1wi/Portspoof/master/tools/portspoof_signatures

echo "Files moved to /etc/portspoof:"
ls -l /etc/portspoof || true
echo

echo -e "\n\033[1;31mWARNING: Redirecting 1:65535 to 4444 can break SSH.\033[0m"
echo -e "\033[1;31mIf you run this remotely, whitelist SSH BEFORE enabling the rule.\033[0m\n"

read -r -p "Do you want to start Portspoof now? [y/n] " answer
if [[ "${answer,,}" == "y" ]]; then
  # Avoid duplicating the rule
  if ! sudo iptables -t nat -C PREROUTING -p tcp -m tcp --dport 1:65535 -j REDIRECT --to-ports 4444 2>/dev/null; then
    sudo iptables -t nat -A PREROUTING -p tcp -m tcp --dport 1:65535 -j REDIRECT --to-ports 4444
  fi
  sudo portspoof -c /etc/portspoof/portspoof.conf -s /etc/portspoof/portspoof_signatures
fi

echo -e "\n\033[1;34m_________________________________________________________\033[0m\n"
echo "Iptables rules:"
echo "Add:    sudo iptables -t nat -A PREROUTING -p tcp -m tcp --dport 1:65535 -j REDIRECT --to-ports 4444"
echo "Delete: sudo iptables -t nat -D PREROUTING -p tcp -m tcp --dport 1:65535 -j REDIRECT --to-ports 4444"
echo
echo "Run Portspoof:"
echo "sudo portspoof -c /etc/portspoof/portspoof.conf -s /etc/portspoof/portspoof_signatures"
echo -e "\n\033[1;34m_________________________________________________________\033[0m\n"

# Cleanup build dir
rm -rf portspoof

echo -e "\n\033[1;33m_________________________________________________________\033[0m"
echo "Flush NAT table (careful):"
echo "sudo iptables -t nat -F"
echo -e "\033[1;33m_________________________________________________________\033[0m\n"