#!/usr/bin/env bash
set -euo pipefail

PIDFILE="/tmp/cloudflared_tunnel.pid"
LOGFILE="/tmp/cloudflared_tunnel.log"

# URLs
URL_DEB_AMD="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64.deb"
URL_RPM_AMD="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-x86_64.rpm"
URL_BIN_AMD="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64"
URL_BIN_ARM="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-arm64"

echo_msg() {
    echo "=============================================="
    echo "$1"
    echo "=============================================="
}

# Helpers
is_running_pid() {
  local pid="$1"
  [ -n "$pid" ] && kill -0 "$pid" 2>/dev/null
}

find_cloudflared_pid() {
  if [ -f "$PIDFILE" ]; then
    pid="$(cat "$PIDFILE" 2>/dev/null || true)"
    if is_running_pid "$pid"; then
      echo "$pid"
      return 0
    else
      rm -f "$PIDFILE" 2>/dev/null || true
    fi
  fi
  pid="$(pgrep -u "$(id -u)" -f "cloudflared tunnel run" | head -n1 || true)"
  if [ -n "$pid" ]; then
    echo "$pid"
    return 0
  fi
  pid="$(pgrep -u "$(id -u)" -f "cloudflared" | head -n1 || true)"
  if [ -n "$pid" ]; then
    echo "$pid"
    return 0
  fi
  return 1
}

show_configured_tunnels() {
  echo_msg "Configured tunnels"
  echo -e "\033[1;32m  http.4rji.com    ->  http://127.0.0.1:80  \033[0m"
  echo -e "\033[1;33m  3000.4rji.com    ->  http://localhost:3000  \033[0m"
  echo -e "\033[1;35m  8080.4rji.com    ->  http://localhost:8080  \033[0m"
  echo -e "\033[1;35m  9000.4rji.com    ->  http://localhost:9000  \033[0m"
  echo -e "\033[1;36m  smb.4rji.com     ->  smb://127.0.0.1:445  \033[0m"
  echo -e "\033[1;36m  sssh.4rji.com    ->  ssh  \033[0m"
  echo ""
}

install_cloudflared() {
  echo ""
  echo "_________________________________________________________"
  echo ""
  echo -e "\033[1;37m Select version to download (wget only):\033[0m"
  echo ""
  echo "  1) amd64 .deb   ($URL_DEB_AMD)"
  echo "  2) amd64 .rpm   ($URL_RPM_AMD)"
  echo "  3) amd64 binary ($URL_BIN_AMD)"
  echo "  4) arm64 binary ($URL_BIN_ARM)"
  echo ""
  read -n1 -rp "Option: " opt
  echo ""
  echo "_________________________________________________________"
  echo ""

  case "$opt" in
    1)
      echo_msg "wget amd64 .deb"
      wget -O cloudflared-linux-amd64.deb "$URL_DEB_AMD"
      ;;
    2)
      echo_msg "wget amd64 .rpm"
      wget -O cloudflared-linux-x86_64.rpm "$URL_RPM_AMD"
      ;;
    3)
      echo_msg "wget amd64 binary"
      wget -O cloudflared-linux-amd64 "$URL_BIN_AMD"
      ;;
    4)
      echo_msg "wget arm64 binary"
      wget -O cloudflared-linux-arm64 "$URL_BIN_ARM"
      ;;
    *)
      echo -e "\033[1;31m Invalid option\033[0m"
      ;;
  esac

  echo ""
  echo "_________________________________________________________"
  echo ""
}

start_tunnel() {
  if [ -z "${cloudtoken:-}" ]; then
    echo ""
    echo "_________________________________________________________"
    echo ""
    echo -e "\033[1;31m Error: cloudtoken variable is empty. Set \$cloudtoken and retry.\033[0m"
    echo ""
    return 1
  fi

  echo ""
  echo "_________________________________________________________"
  echo ""
  echo -e "\033[1;34m Starting cloudflared tunnel with provided token...\033[0m"

  local start_cmd=("cloudflared" "tunnel" "run" "--token" "$cloudtoken")
  if command -v setsid >/dev/null 2>&1; then
    start_cmd=(setsid "${start_cmd[@]}")
  fi

  # Run detached so Ctrl+C or closing the menu does not kill the tunnel.
  if command -v nohup >/dev/null 2>&1; then
    nohup bash -c 'trap "" INT HUP; exec "$@"' _ "${start_cmd[@]}" >"$LOGFILE" 2>&1 </dev/null &
  else
    ( trap '' INT HUP; "${start_cmd[@]}" >"$LOGFILE" 2>&1 </dev/null ) &
  fi

  CF_PID=$!
  echo "$CF_PID" > "$PIDFILE" || true

  sleep 1
  echo ""
  echo "_________________________________________________________"
  echo ""

  echo_msg "Tunnels created successfully"
  show_configured_tunnels

  echo -e "\033[1;37m  cloudflared PID:  $CF_PID  \033[0m"
  echo -e "\033[1;31m  To stop the tunnel:  kill $CF_PID  \033[0m"
  echo -e "\033[1;30m  Log file: $LOGFILE\033[0m"
  echo ""
  echo "_________________________________________________________"
  echo ""
}

kill_tunnel() {
  echo ""
  echo "_________________________________________________________"
  echo ""
  pid="$(find_cloudflared_pid || true)"
  if [ -n "$pid" ]; then
    echo -e "\033[1;33m cloudflared tunnel is running (PID: $pid)\033[0m"
    echo -e "\033[1;31m Killing cloudflared tunnel (PID: $pid)...\033[0m"
    kill "$pid" && sleep 1
    if ! is_running_pid "$pid"; then
      echo -e "\033[1;32m cloudflared tunnel stopped.\033[0m"
      rm -f "$PIDFILE" 2>/dev/null || true
    else
      echo -e "\033[1;31m Failed to stop cloudflared (PID: $pid).\033[0m"
      return 2
    fi
  else
    echo -e "\033[1;31m No running cloudflared tunnel found.\033[0m"
  fi
  echo ""
  echo "_________________________________________________________"
  echo ""
}

status_and_tunnels() {
  echo ""
  echo "_________________________________________________________"
  echo ""

  show_configured_tunnels

  pid="$(find_cloudflared_pid || true)"
  if [ -n "$pid" ]; then
    echo -e "\033[1;32m cloudflared is running (PID: $pid)\033[0m"
    echo ""
    if command -v ps >/dev/null 2>&1; then
      echo -e "\033[1;37m Command:\033[0m"
      ps -o pid,cmd -p "$pid" --no-headers 2>/dev/null || ps -p "$pid" -o cmd --no-headers 2>/dev/null || true
      echo ""
    fi
  else
    echo -e "\033[1;31m cloudflared is not running\033[0m"
    echo ""
  fi

  if command -v cloudflared >/dev/null 2>&1; then
    echo -e "\033[1;37m cloudflared tunnel list (if available):\033[0m"
    cloudflared tunnel list 2>/dev/null || true
    echo ""
  fi

  if [ -n "${pid:-}" ]; then
    echo -e "\033[1;31m To stop: choose option 3 or k (kill tunnel) or run: kill $pid\033[0m"
  fi

  echo ""
  echo "_________________________________________________________"
  echo ""
}

menu() {
  echo ""
  echo -e "\033[1;36m================== cloudflared menu ==================\033[0m"
  echo -e "\033[1;32m  1) Start tunnel\033[0m"
  echo -e "\033[1;33m  2) Install cloudflared (wget)\033[0m"
  echo -e "\033[1;31m  3) Kill tunnel (alias: k)\033[0m"
  echo -e "\033[1;35m  s) Status + tunnels\033[0m"
  echo -e "\033[1;31m  k) Kill tunnel\033[0m"
  echo -e "\033[1;37m  q) Quit\033[0m"
  echo -e "\033[1;36m======================================================\033[0m"
  echo ""
  echo -e "\033[1;30mNOTE:\033[0m"
  echo -e "\033[1;30m  ./cloudflared-linux-amd64 tunnel run --token \$cloudtoken &\033[0m"
  echo ""
}




while true; do
  menu
  read -n1 -rp "Option: " choice
  echo ""
  case "$choice" in
    1) start_tunnel ;;
    2) install_cloudflared ;;
    3|k|K) kill_tunnel ;;
    s|S|4) status_and_tunnels ;;
    q|Q)
       echo "Bye."
       exit 0
       ;;
    *)
       echo -e "\033[1;31m Invalid option\033[0m"
       ;;
  esac
done
