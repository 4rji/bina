#!/bin/bash
set -euo pipefail

# --- root check ---
if [[ $EUID -ne 0 ]]; then
    script_path="$(readlink -f "$0")"
    echo -e "\033[31mThis script requires sudo.\033[0m"
    echo -e "\033[33mRun it with:\033[0m"
    echo -e "\033[36msudo $script_path\033[0m"
    exit 1
fi

echo -e "\033[36müîé Conexiones a/desde redes privadas (RFC1918) + UDP locales abiertos\033[0m"

echo -e "\033[33m\n1Ô∏è‚É£ TCP ESTABLISHED hacia RFC1918:\033[0m"
netstat -ant 2>/dev/null | awk '/ESTABLISHED/ && ($5 ~ /^(10\.|192\.168\.|172\.(1[6-9]|2[0-9]|3[01])\.)/){print}'

echo -e "\033[33m\n2Ô∏è‚É£ UDP connected (with peer) to RFC1918:\033[0m"
netstat -anu 2>/dev/null | awk '($5 ~ /^(10\.|192\.168\.|172\.(1[6-9]|2[0-9]|3[01])\.)/){print}'

echo -e "\033[33m\n3Ô∏è‚É£ Local UDP sockets without peer (mosh, DNS, mDNS, etc.):\033[0m"
( lsof -nP -iUDP 2>/dev/null || true ) | awk '$9 ~ /^\*:/ || $9 ~ /^0\.0\.0\.0:/ || $9 ~ /^\[::\]:/'

echo -e "\033[33m\n4Ô∏è‚É£ Processes related to RFC1918 or UDP no-peer sockets:\033[0m"
( lsof -nP -i 2>/dev/null || true ) | egrep -E '10\.|192\.168|172\.(1[6-9]|2[0-9]|3[01])|\*:|0\.0\.0\.0:|\[::\]:'

echo -e "\033[33m\n5Ô∏è‚É£ Optional packet capture (50 packets, RFC1918 SRC/DST):\033[0m"

read -r -p "Do you want to run tcpdump? (y/N): " ans

if [[ "$ans" == "y" || "$ans" == "Y" ]]; then
    tcpdump -n -i any \
      '(dst net 10.0.0.0/8 or dst net 192.168.0.0/16 or dst net 172.16.0.0/12 or src net 10.0.0.0/8 or src net 192.168.0.0/16 or src net 172.16.0.0/12)' \
      -c 50
else
    echo -e "\033[31mSkipping tcpdump.\033[0m"
fi