#!/usr/bin/env bash

# Colores
verde="\033[1;32m"
rojo="\033[1;31m"
amarillo="\033[1;33m"
reset="\033[0m"

if [ -z "$1" ]; then
  printf "${rojo}Uso: %s archivo${reset}\n" "$0"
  exit 1
fi

archivo="$1"

# Temp seguro en macOS/Linux (evita /dev/shm)
fuente="$(mktemp "${TMPDIR:-/tmp}/extr.XXXXXX")" || exit 1
strings -- "$archivo" > "$fuente"

printf "\n${amarillo}¿Qué deseas extraer?${reset}\n"
printf "1) IPs\n"
printf "2) Dominios\n"
printf "3) URLs\n"
printf "4) Todo\n"
read -r -p "Selecciona (1-4): " opcion
read -r -p "¿Deseas aplicar sort y uniq? (s/n): " ordenar

case "$opcion" in
  1)
    patron='([0-9]{1,3}\.){3}[0-9]{1,3}'
    nombre="ips.txt"
    ;;
  2)
    patron='([[:alnum:]-]+\.)+[[:alpha:]]{2,}'
    nombre="dominios.txt"
    ;;
  3)
    patron='https?://[[:alnum:]./?=_-]+'
    nombre="urls.txt"
    ;;
  4)
    patron='([0-9]{1,3}\.){3}[0-9]{1,3}|([[:alnum:]-]+\.)+[[:alpha:]]{2,}|https?://[[:alnum:]./?=_-]+'
    nombre="todo.txt"
    ;;
  *)
    printf "${rojo}Opción no válida.${reset}\n"
    rm -f -- "$fuente"
    exit 1
    ;;
esac

printf "${amarillo}[+] Ejecutando: grep -Eo \"%s\" \"%s\" > \"%s\"${reset}\n" "$patron" "$fuente" "$nombre"
# Extrae
grep -Eo "$patron" -- "$fuente" > "$nombre"

# Ordena/únicos si se pidió
if [ "$ordenar" = "s" ] || [ "$ordenar" = "S" ]; then
  printf "${amarillo}[+] Ejecutando: sort -u \"%s\" -o \"%s\"${reset}\n" "$nombre" "$nombre"
  sort -u "$nombre" -o "$nombre"
fi

# Resultado
printf "${verde}[+] Resultado guardado en: %s${reset}\n" "$nombre"
printf "${verde}[+] Número de líneas extraídas: %s${reset}\n" "$(wc -l < "$nombre")"

# Limpieza
rm -f -- "$fuente"
