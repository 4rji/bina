#!/usr/bin/env bash
set -euo pipefail



# Lista de paquetes a instalar
paquetes=("iptables" )

# Función para verificar si un paquete está instalado (Debian/Ubuntu/Kali)
paquete_instalado_apt() {
    dpkg -l "$1" | grep -q '^ii'  
}

# Función para verificar si un paquete está instalado (CentOS/RHEL)
paquete_instalado_yum() {
    yum list installed "$1" &> /dev/null
}

# Función para verificar si un paquete está instalado (Fedora)
paquete_instalado_dnf() {
    dnf list installed "$1" &> /dev/null
}

# Función para verificar si un paquete está instalado (Arch Linux)
paquete_instalado_pacman() {
    pacman -Qi "$1" &> /dev/null
}

# Detectar el sistema operativo
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$ID
fi

# Instalar paquetes basados en el sistema operativo
for paquete in "${paquetes[@]}"; do
    case $OS in
        "debian"|"ubuntu"|"kali")
            if ! paquete_instalado_apt "$paquete"; then
                echo "Instalando el paquete $paquete..."
                sudo apt-get install -y "$paquete"
            fi
            ;;
        "centos"|"rhel")
            if ! paquete_instalado_yum "$paquete"; then
                echo "Instalando el paquete $paquete..."
                sudo yum install -y "$paquete"
            fi
            ;;
        "fedora")
            if ! paquete_instalado_dnf "$paquete"; then
                echo "Instalando el paquete $paquete..."
                sudo dnf install -y "$paquete"
            fi
            ;;
        "arch")
            if ! paquete_instalado_pacman "$paquete"; then
                echo "Instalando el paquete $paquete..."
                sudo pacman -S --noconfirm "$paquete"
            fi
            ;;
        *)
            ;;
    esac
done


# CCDC – hard ICMP block (iptables)
# default: apply
# flags:  -r revert | -s status

RULE4_IN=(-p icmp -j DROP -m comment --comment "ccdc-block-icmp-all")
RULE4_OUT=(-p icmp -j DROP -m comment --comment "ccdc-block-icmp-all")
RULE6_IN=(-p ipv6-icmp -j DROP -m comment --comment "ccdc-block-icmpv6-all")
RULE6_OUT=(-p ipv6-icmp -j DROP -m comment --comment "ccdc-block-icmpv6-all")

need_root() { [[ "${EUID:-$(id -u)}" -eq 0 ]] || exec sudo -E "$0" "$@"; }
need_root "$@"

IPT=iptables
IP6T=ip6tables
HAVE_V6=1
command -v "$IP6T" >/dev/null 2>&1 || HAVE_V6=0

add() {
  local bin="$1" chain="$2"; shift 2
  if "$bin" -C "$chain" "$@" 2>/dev/null; then
    echo "EXISTS: $bin -C $chain $*"
  else
    echo "EXEC:   $bin -I $chain 1 $*"
    "$bin" -I "$chain" 1 "$@"
  fi
}

del() {
  local bin="$1" chain="$2"; shift 2
  if "$bin" -C "$chain" "$@" 2>/dev/null; then
    echo "EXEC:   $bin -D $chain $*"
    "$bin" -D "$chain" "$@"
  else
    echo "MISSING:$bin -D $chain $*"
  fi
}

status() {
  echo "=== IPv4 ==="
  $IPT -S INPUT  | grep -F "ccdc-block-icmp-all" || true
  $IPT -S OUTPUT | grep -F "ccdc-block-icmp-all" || true
  echo "=== IPv6 ==="
  if [[ "$HAVE_V6" -eq 1 ]]; then
    $IP6T -S INPUT  | grep -F "ccdc-block-icmpv6-all" || true
    $IP6T -S OUTPUT | grep -F "ccdc-block-icmpv6-all" || true
  fi
}

show_flags() {
  cat <<'EOF'
Flags:
  -r   revert (remove ICMP blocks)
  -s   status (show rules)
EOF
}

case "${1:-}" in
  -r)
    del "$IPT"  INPUT  "${RULE4_IN[@]}"
    del "$IPT"  OUTPUT "${RULE4_OUT[@]}"
    [[ "$HAVE_V6" -eq 1 ]] && del "$IP6T" INPUT "${RULE6_IN[@]}" && del "$IP6T" OUTPUT "${RULE6_OUT[@]}"
    ;;
  -s)
    status
    ;;
  *)
    # APPLY (default)
    add "$IPT"  INPUT  "${RULE4_IN[@]}"
    add "$IPT"  OUTPUT "${RULE4_OUT[@]}"
    [[ "$HAVE_V6" -eq 1 ]] && add "$IP6T" INPUT "${RULE6_IN[@]}" && add "$IP6T" OUTPUT "${RULE6_OUT[@]}"
    show_flags
    ;;
esac


#thisi is a test
