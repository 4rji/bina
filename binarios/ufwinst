#!/usr/bin/env bash

echo -e "\n\033[1;34m_________________________________________________________\033[0m\n"
echo "UFW configuration in progress..."
echo ""

# List of packages to install
packages=("ufw")

# Function to check if a package is installed (Debian/Ubuntu/Kali)
is_package_installed_apt() {
    dpkg -l "$1" | grep -q '^ii'
}

# Function to check if a package is installed (Red Hat/CentOS/Fedora)
is_package_installed_yum_dnf() {
    yum list installed "$1" &>/dev/null || dnf list installed "$1" &>/dev/null
}

# Detect operating system
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$ID
fi

# Install UFW depending on the operating system
for package in "${packages[@]}"; do
    case $OS in
        "debian"|"ubuntu"|"kali")
            if ! is_package_installed_apt "$package"; then
                echo "Installing package $package..."
                sudo apt-get update && sudo apt-get install -y "$package"
            fi
            ;;
        "centos"|"rhel"|"fedora")
            if ! is_package_installed_yum_dnf "$package"; then
                echo "Installing package $package..."
                sudo yum install -y "$package" || sudo dnf install -y "$package"
            fi
            ;;
        *)
            echo "Unsupported operating system."
            exit 1
            ;;
    esac
done

# Enable logging and configure basic firewall rules
echo -e "\n\033[1;34mEnabling UFW and configuring basic rules...\033[0m\n"
sudo ufw logging high
sudo ufw allow 22/tcp
echo "Port 22/tcp (SSH) is allowed by default."

# Ask user for additional ports
echo -e "\n\033[1;36mEnter additional ports you want to allow (space-separated):\033[0m"
read -r additional_ports

# Add rules for additional ports
if [ -n "$additional_ports" ]; then
    for port in $additional_ports; do
        sudo ufw allow "$port/tcp"
        echo "Port $port/tcp allowed."
    done
else
    echo "No additional ports were added."
fi

# Enable and reload UFW
sudo ufw enable
sudo ufw reload

# Show UFW status
echo -e "\n\033[1;34mFinal UFW status:\033[0m\n"
sudo ufw status verbose