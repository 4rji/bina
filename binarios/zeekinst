#!/usr/bin/env bash
# Instala Zeek en Debian 12/13 + servicio systemd
set -euo pipefail

#--- root requerido
[ "$EUID" -ne 0 ] && { echo "Ejecuta como root"; exit 1; }

apt install gpg
#--- detectar versión
. /etc/os-release
case "${VERSION_CODENAME:-}" in
  trixie) DIST="Debian_13" ;;
  bookworm) DIST="Debian_12" ;;
  *) echo "Solo soporta Debian 12/13 (detectado: ${VERSION_CODENAME:-unknown})"; exit 1 ;;
esac

#--- repo Zeek
echo "deb http://download.opensuse.org/repositories/security:/zeek/${DIST}/ /" \
  | tee /etc/apt/sources.list.d/security:zeek.list
curl -fsSL "https://download.opensuse.org/repositories/security:zeek/${DIST}/Release.key" \
  | gpg --dearmor > /etc/apt/trusted.gpg.d/security_zeek.gpg

apt update
apt install -y --no-install-recommends zeek

#--- PATH global
echo 'export PATH="$PATH:/opt/zeek/bin"' > /etc/profile.d/zeek.sh
chmod 644 /etc/profile.d/zeek.sh

#--- interfaz por default
IFACE="$(ip -o -4 route show to default | awk '{print $5}' | head -n1)"
[ -z "$IFACE" ] && { echo "No se detectó interfaz. Edita /opt/zeek/etc/node.cfg manualmente."; exit 1; }

#--- node.cfg standalone
cat > /opt/zeek/etc/node.cfg <<EOF
[zeek]
type=standalone
host=localhost
interface=${IFACE}
EOF

#--- primer deploy
/opt/zeek/bin/zeekctl deploy || true

#--- servicio systemd
cat > /etc/systemd/system/zeek.service <<'EOF'
[Unit]
Description=Zeek Network Security Monitor
After=network-online.target
Wants=network-online.target

[Service]
Type=forking
ExecStart=/opt/zeek/bin/zeekctl start
ExecStop=/opt/zeek/bin/zeekctl stop
ExecReload=/opt/zeek/bin/zeekctl restart
WorkingDirectory=/opt/zeek
Restart=on-failure

[Install]
WantedBy=multi-user.target
EOF

systemctl daemon-reload
systemctl enable --now zeek

echo -e "\n\e[92m✅ Zeek instalado y corriendo en interfaz:\e[0m  \e[96m${IFACE}\e[0m\n"
echo -e "\e[93mConfig:\e[0m  \e[96m/opt/zeek/etc/node.cfg\e[0m\n"
echo -e "\e[93mLogs:\e[0m    \e[96m/opt/zeek/spool/zeek (live)\e[0m"
echo -e "         \e[96m/opt/zeek/logs/<timestamp>/ (rotados)\e[0m\n"