#!/usr/bin/env bash
set -euo pipefail

# Colors
GREEN='\033[0;32m'
BLUE='\033[1;34m'
YELLOW='\033[1;33m'
NC='\033[0m'

banner() { echo -e "${BLUE}\n=== $* ===${NC}"; }
cmd()    { echo -e "${GREEN}$*${NC}"; }
note()   { echo -e "${YELLOW}$*${NC}"; }

# ---- Config ----
MODULE_NAME="${1:-yourModuleName}"
OUT_NAME="airsend"
PKG_DIR="."
# ----------------

banner "Step 1: Initialize Go module"
cmd "go mod init ${MODULE_NAME}"
note "Si go.mod ya existe, ignora este paso."

banner "Step 2: Download dependencies"
cmd "go get github.com/AlecAivazis/survey/v2"
cmd "go mod tidy"

banner "Step 3: Build (native, optimized)"
cmd "go build -trimpath -ldflags \"-s -w\" -o ${OUT_NAME} ${PKG_DIR}"

banner "Step 4: Optional UPX compression"
note "Opcional"
cmd "upx --best --lzma ${OUT_NAME}"

banner "Step 5: Cross-compile Linux amd64 (static, reproducible)"
cmd "GOCACHE=/tmp/gocache CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -trimpath -ldflags \"-s -w\" -o ${OUT_NAME} ${PKG_DIR}"

banner "Step 6: Vendor dependencies (offline builds)"
cmd "go mod vendor"

banner "Step 7: Linux amd64 using vendor"
cmd "GOCACHE=/tmp/gocache CGO_ENABLED=0 GOOS=linux GOARCH=amd64 go build -mod=vendor -trimpath -ldflags \"-s -w\" -o ${OUT_NAME} ${PKG_DIR}"

banner "Step 8: Windows amd64"
cmd "GOOS=windows GOARCH=amd64 CGO_ENABLED=0 go build -trimpath -ldflags \"-s -w\" -o ${OUT_NAME}-windows-amd64.exe ${PKG_DIR}"

banner "Done"