#!/usr/bin/env bash

# ==============================================
# IPSET / IPTABLES blocking
# - If you pass a FILE: blocks all IPs in the file (one per line).
# - If you pass an IP: menu to block/check/unblock that IP.
# - With no args: shows usage.
# ==============================================

# Packages to install
paquetes=("ipset" "iptables" "iptables-persistent" "kmod")

# Package check helpers
paquete_instalado_apt() { dpkg -l "$1" | grep -q '^ii'; }
paquete_instalado_yum() { yum list installed "$1" &> /dev/null; }
paquete_instalado_dnf() { dnf list installed "$1" &> /dev/null; }
paquete_instalado_pacman() { pacman -Qi "$1" &> /dev/null; }

# Detect OS
if [ -f /etc/os-release ]; then
  . /etc/os-release
  OS=$ID
fi

# Install packages per OS
for paquete in "${paquetes[@]}"; do
  case $OS in
    "debian"|"ubuntu"|"kali")
      if ! paquete_instalado_apt "$paquete"; then
        echo "Installing $paquete..."
        sudo apt-get install -y "$paquete"
      fi
      ;;
    "centos"|"rhel")
      if ! paquete_instalado_yum "$paquete"; then
        echo "Installing $paquete..."
        sudo yum install -y "$paquete"
      fi
      ;;
    "fedora")
      if ! paquete_instalado_dnf "$paquete"; then
        echo "Installing $paquete..."
        sudo dnf install -y "$paquete"
      fi
      ;;
    "arch")
      if ! paquete_instalado_pacman "$paquete"; then
        echo "Installing $paquete..."
        sudo pacman -S --noconfirm "$paquete"
      fi
      ;;
    *) ;;
  esac
done

# -------------------------
# Utilities
# -------------------------

# Colored message (31 red, 34 blue, 35 magenta default, 32 green, 33 yellow)
echo_msg() {
  local msg="$1"
  local color="${2:-35}"
  echo -e "\n=============================================="
  echo -e "\033[1;${color}m${msg}\033[0m"
  echo -e "==============================================\n"
}

# Ensure ipset and iptables rule
ensure_set() { sudo ipset list blacklist &>/dev/null || sudo ipset create blacklist hash:ip; }
ensure_iptables() {
  sudo iptables -C INPUT -m set --match-set blacklist src -j DROP &>/dev/null || \
  sudo iptables -I INPUT -m set --match-set blacklist src -j DROP
}

# Save configuration
save_conf() {
  sudo ipset save | sudo tee /etc/ipset.conf > /dev/null
  sudo iptables-save | sudo tee /etc/iptables/rules.v4 > /dev/null
}

# Usage
display_usage() {
  echo_msg "Usage" 34
  cat <<EOF
  $0 <file>          → Blocks all listed IPs (one per line)
  $0 <IP>            → Menu to block/check/unblock that IP
  $0                 → Show this help

Examples:
  $0 lista_ips.txt
  $0 203.0.113.10
EOF
}

# Block IPs from file
block_file() {
  local file="$1"
  echo_msg "Loading and blocking IPs from: $file" 34
  sudo ipset flush blacklist
  # Ignore empty lines and comments (#)
  while IFS= read -r ip; do
    [[ -z "$ip" || "$ip" =~ ^[[:space:]]*# ]] && continue
    sudo ipset add blacklist "$ip" 2>/dev/null
  done < "$file"
  ensure_iptables
  save_conf
  echo_msg "Blocklist applied from $file" 34
}

# Block a single IP
block_ip() {
  echo_msg "Blocking IP: $1" 31
  sudo ipset add blacklist "$1" 2>/dev/null
  ensure_iptables
  echo_msg "IP $1 blocked" 31
}

# Check IP
check_ip() {
  if sudo ipset test blacklist "$1" &>/dev/null; then
    echo_msg "IP $1 is in the blacklist" 34
  else
    echo_msg "IP $1 is NOT in the blacklist" 34
  fi
}

# Remove IP
delete_ip() {
  echo_msg "Removing IP: $1" 32
  sudo ipset test blacklist "$1" &>/dev/null && sudo ipset del blacklist "$1"
  echo_msg "IP $1 removed if it existed" 32
}

# -------------------------
# Start
# -------------------------

ensure_set
tput civis 2>/dev/null

# No args → help
if [[ $# -eq 0 ]]; then
  display_usage
  tput cnorm 2>/dev/null
  exit 0
fi

ARG="$1"

# If it's a readable file → block from file
if [[ -f "$ARG" && -r "$ARG" ]]; then
  block_file "$ARG"
  tput cnorm 2>/dev/null
  exit 0
fi

# If it looks like an IP → action menu
IP_REGEX='^([0-9]{1,3}\.){3}[0-9]{1,3}(/[0-9]{1,2})?$'
if [[ "$ARG" =~ $IP_REGEX ]]; then
  IP="$ARG"
  while true; do
    echo -e "\nActions for IP $IP:"
    echo "  b) Block"
    echo "  c) Check"
    echo "  d) Unblock"
    echo "  q) Quit"
    read -n1 -p "Choose an option: " action
    echo
    case "$action" in
      b|B) block_ip "$IP" ;;
      c|C) check_ip "$IP" ;;
      d|D) delete_ip "$IP" ;;
      q|Q) save_conf; break ;;
      *) echo_msg "Invalid option" 33 ;;
    esac
  done
  tput cnorm 2>/dev/null
  exit 0
fi

# If it's not a file or a valid IP → help
echo_msg "Unrecognized argument: $ARG" 33
display_usage
tput cnorm 2>/dev/null
exit 1
