#!/usr/bin/env bash

# Función para mostrar mensajes
echo_msg() {
    echo ""
    echo "=============================================="
    echo -e "\033[1;35m$1\033[0m"
    echo "=============================================="
    echo ""
}

echo ""
echo -e "\033[1;36m  Uso:\033[0m"
echo -e "\033[1;32m    ./script.sh <IP>            \033[0m→ Agrega una IP al blacklist"
echo -e "\033[1;33m    ./script.sh                 \033[0m→ Carga y bloquea IPs desde ips.txt"
echo -e "\033[1;31m    ./script.sh -d <IP>         \033[0m→ Elimina una IP del blacklist"
echo -e "\033[1;31m    ./script.sh -d              \033[0m→ Elimina IPs del archivo ips.txt"
echo ""
echo -e "\033[1;34m_________________________________________________________\033[0m"
echo ""

# Verifica si hay argumento o archivo ips.txt
if [[ -z "$1" && ! -f ips.txt ]]; then
    echo_msg "No se proporcionó una IP ni se encontró el archivo ips.txt. Abortando."
    exit 1
fi

# Crear el set si no existe
ipset list blacklist &>/dev/null || ipset create blacklist hash:ip

# Modo eliminar
if [[ "$1" == "-d" ]]; then
    if [[ -n "$2" ]]; then
        echo_msg "Eliminando IP del blacklist: $2"
        ipset del blacklist "$2"
    elif [[ -f ips.txt ]]; then
        echo_msg "Eliminando IPs del archivo ips.txt"
        while read ip; do ipset del blacklist "$ip"; done < ips.txt
    else
        echo_msg "No se proporcionó IP ni archivo. Abortando."
        exit 1
    fi

    ipset save > /etc/ipset.conf
    echo_msg "IPs eliminadas del set. Configuración actualizada."
    exit 0
fi

# Agregar IP individual
if [[ -n "$1" ]]; then
    echo_msg "Agregando IP al blacklist: $1"
    ipset add blacklist "$1"
else
    # Agregar desde archivo
    echo_msg "Cargando IPs desde archivo ips.txt"
    ipset flush blacklist
    while read ip; do ipset add blacklist "$ip"; done < ips.txt
fi

# Aplicar regla iptables si no existe
iptables -C INPUT -m set --match-set blacklist src -j DROP 2>/dev/null || \
iptables -I INPUT -m set --match-set blacklist src -j DROP

echo_msg "Regla iptables aplicada para bloquear blacklist"

# Guardar configuración
ipset save > /etc/ipset.conf
iptables-save > /etc/iptables/rules.v4

echo -e "\033[1;36m  Configuración guardada en /etc/ipset.conf y /etc/iptables/rules.v4\033[0m"
echo ""
echo -e "\033[1;34m_________________________________________________________\033[0m"
echo ""