#!/usr/bin/env bash

echo -e "\n\e[92mVerificando e instalando OpenSSH Server...\e[0m\n"

# Lista de paquetes a instalar
paquetes=( "openssh-server")

# Función para verificar si un paquete está instalado (Debian/Ubuntu/Kali)
paquete_instalado_apt() {
    dpkg -l "$1" | grep -q '^ii'  
}

# Función para verificar si un paquete está instalado (CentOS/RHEL)
paquete_instalado_yum() {
    yum list installed "$1" &> /dev/null
}

# Función para verificar si un paquete está instalado (Fedora)
paquete_instalado_dnf() {
    dnf list installed "$1" &> /dev/null
}

# Función para verificar si un paquete está instalado (Arch Linux)
paquete_instalado_pacman() {
    pacman -Qi "$1" &> /dev/null
}

# Detectar el sistema operativo
if [ -f /etc/os-release ]; then
    . /etc/os-release
    OS=$ID
fi

# Instalar paquetes basados en el sistema operativo
for paquete in "${paquetes[@]}"; do
    case $OS in
        "debian"|"ubuntu"|"kali")
            if ! paquete_instalado_apt "$paquete"; then
                echo "Instalando el paquete $paquete..."
                sudo apt-get install -y "$paquete"
            fi
            ;;
        "centos"|"rhel")
            if ! paquete_instalado_yum "$paquete"; then
                echo "Instalando el paquete $paquete..."
                sudo yum install -y "$paquete"
            fi
            ;;
        "fedora")
            if ! paquete_instalado_dnf "$paquete"; then
                echo "Instalando el paquete $paquete..."
                sudo dnf install -y "$paquete"
            fi
            ;;
        "arch")
            if ! paquete_instalado_pacman "$paquete"; then
                echo "Instalando el paquete $paquete..."
                sudo pacman -S --noconfirm "$paquete"
            fi
            ;;
        *)
            ;;
    esac
done




# --- Vars ---
USERNAME_DEFAULT="ccdc"
PASSWORD_DEFAULT="itecitec"
GROUP_NAME="sftp_users"
# Detecta ruta válida de sshd_config y nologin
SSH_CONFIG="/etc/ssh/sshd_config"; [[ -f /etc/ssh/sshd_config ]] || SSH_CONFIG="/etc/ssh/ssh_config"
NOLOGIN_BIN="$(command -v /usr/sbin/nologin || command -v /sbin/nologin || command -v /bin/false)"
CHROOT_BASE="/home"

echo_msg(){ printf "\n\033[95m==============================================\033[0m\n\033[93m%s\033[0m\n\033[95m==============================================\033[0m\n" "$1"; }

restart_ssh(){
  if command -v systemctl >/dev/null 2>&1; then
    sudo systemctl restart ssh 2>/dev/null || sudo systemctl restart sshd 2>/dev/null || true
  else
    sudo service ssh restart 2>/dev/null || sudo service sshd restart 2>/dev/null || true
  fi
}

# garantiza que el archivo exista para que grep no truene
ensure_file(){
  local f="$1"
  sudo mkdir -p "$(dirname "$f")"
  sudo touch "$f"
  sudo chown root:root "$f"
  sudo chmod 644 "$f"
}

ensure_line(){
  local l="$1" f="$2"
  ensure_file "$f"
  grep -qF -- "$l" "$f" 2>/dev/null || echo "$l" | sudo tee -a "$f" >/dev/null
}

ensure_match_block(){
  local f="$1" m="# SFTP GROUP BLOCK (autogen)"
  ensure_file "$f"
  grep -q "$m" "$f" 2>/dev/null || sudo tee -a "$f" >/dev/null <<'EOT'

# SFTP GROUP BLOCK (autogen)
Subsystem sftp internal-sftp
Match Group sftp_users
    ChrootDirectory /home
    X11Forwarding no
    AllowTcpForwarding no
    ForceCommand internal-sftp -d /%u
# END SFTP GROUP BLOCK
EOT
}

create_sftp_user(){
  local user="$1" pass="$2"
  sudo getent group "$GROUP_NAME" >/dev/null || sudo groupadd "$GROUP_NAME"

  if ! id -u "$user" >/dev/null 2>&1; then
    sudo useradd -g "$GROUP_NAME" -m -d "/home/$user" -s "$NOLOGIN_BIN" "$user"
  else
    sudo usermod -g "$GROUP_NAME" -d "/home/$user" -s "$NOLOGIN_BIN" "$user"
    sudo mkdir -p "/home/$user"
  fi
  echo "${user}:${pass}" | sudo chpasswd

  # permisos chroot/base
  sudo chown root:root "$CHROOT_BASE"
  sudo chmod 755 "$CHROOT_BASE"

  # home del usuario (escribible por el usuario)
  sudo chown "$user:$GROUP_NAME" "/home/$user"
  sudo chmod 755 "/home/$user"
}

# -a agrega usuario y sale
if [[ "${1:-}" == "-a" ]]; then
  read -rp "Usuario: " NUEVO_USR
  read -rsp "Contraseña: " NUEVA_PWD; echo
  create_sftp_user "$NUEVO_USR" "$NUEVA_PWD"
  ensure_line "Subsystem sftp internal-sftp" "$SSH_CONFIG"
  ensure_match_block "$SSH_CONFIG"
  restart_ssh
  echo_msg "Usuario SFTP $NUEVO_USR creado."
  echo -e "\033[96mRuta de subida:\033[0m /$NUEVO_USR\n"
  exit 0
fi

# usuario principal
create_sftp_user "$USERNAME_DEFAULT" "$PASSWORD_DEFAULT"
ensure_line "Subsystem sftp internal-sftp" "$SSH_CONFIG"
ensure_match_block "$SSH_CONFIG"
restart_ssh

echo_msg "SFTP listo."
echo -e "\033[92mUsuario:\033[0m $USERNAME_DEFAULT"
echo -e "\033[92mPassword:\033[0m $PASSWORD_DEFAULT"
echo -e "\033[96mRuta de subida:\033[0m /$USERNAME_DEFAULT\n"
# --- Vars ---
USERNAME_DEFAULT="ccdc"
PASSWORD_DEFAULT="itecitec"
GROUP_NAME="sftp_users"
# Detecta ruta válida de sshd_config y nologin
SSH_CONFIG="/etc/ssh/sshd_config"; [[ -f /etc/ssh/sshd_config ]] || SSH_CONFIG="/etc/ssh/ssh_config"
NOLOGIN_BIN="$(command -v /usr/sbin/nologin || command -v /sbin/nologin || command -v /bin/false)"
CHROOT_BASE="/home"

echo_msg(){ printf "\n\033[95m==============================================\033[0m\n\033[93m%s\033[0m\n\033[95m==============================================\033[0m\n" "$1"; }

restart_ssh(){
  if command -v systemctl >/dev/null 2>&1; then
    sudo systemctl restart ssh 2>/dev/null || sudo systemctl restart sshd 2>/dev/null || true
  else
    sudo service ssh restart 2>/dev/null || sudo service sshd restart 2>/dev/null || true
  fi
}

# garantiza que el archivo exista para que grep no truene
ensure_file(){
  local f="$1"
  sudo mkdir -p "$(dirname "$f")"
  sudo touch "$f"
  sudo chown root:root "$f"
  sudo chmod 644 "$f"
}

ensure_line(){
  local l="$1" f="$2"
  ensure_file "$f"
  grep -qF -- "$l" "$f" 2>/dev/null || echo "$l" | sudo tee -a "$f" >/dev/null
}

ensure_match_block(){
  local f="$1" m="# SFTP GROUP BLOCK (autogen)"
  ensure_file "$f"
  grep -q "$m" "$f" 2>/dev/null || sudo tee -a "$f" >/dev/null <<'EOT'

# SFTP GROUP BLOCK (autogen)
Subsystem sftp internal-sftp
Match Group sftp_users
    ChrootDirectory /home
    X11Forwarding no
    AllowTcpForwarding no
    ForceCommand internal-sftp -d /%u
# END SFTP GROUP BLOCK
EOT
}

create_sftp_user(){
  local user="$1" pass="$2"
  sudo getent group "$GROUP_NAME" >/dev/null || sudo groupadd "$GROUP_NAME"

  if ! id -u "$user" >/dev/null 2>&1; then
    sudo useradd -g "$GROUP_NAME" -m -d "/home/$user" -s "$NOLOGIN_BIN" "$user"
  else
    sudo usermod -g "$GROUP_NAME" -d "/home/$user" -s "$NOLOGIN_BIN" "$user"
    sudo mkdir -p "/home/$user"
  fi
  echo "${user}:${pass}" | sudo chpasswd

  # permisos chroot/base
  sudo chown root:root "$CHROOT_BASE"
  sudo chmod 755 "$CHROOT_BASE"

  # home del usuario (escribible por el usuario)
  sudo chown "$user:$GROUP_NAME" "/home/$user"
  sudo chmod 755 "/home/$user"
}

# -a agrega usuario y sale
if [[ "${1:-}" == "-a" ]]; then
  read -rp "Usuario: " NUEVO_USR
  read -rsp "Contraseña: " NUEVA_PWD; echo
  create_sftp_user "$NUEVO_USR" "$NUEVA_PWD"
  ensure_line "Subsystem sftp internal-sftp" "$SSH_CONFIG"
  ensure_match_block "$SSH_CONFIG"
  restart_ssh
  echo_msg "Usuario SFTP $NUEVO_USR creado."
  echo -e "\033[96mRuta de subida:\033[0m /$NUEVO_USR\n"
  exit 0
fi

# usuario principal
create_sftp_user "$USERNAME_DEFAULT" "$PASSWORD_DEFAULT"
ensure_line "Subsystem sftp internal-sftp" "$SSH_CONFIG"
ensure_match_block "$SSH_CONFIG"
restart_ssh

echo_msg "SFTP listo."
echo -e "\033[92mUsuario:\033[0m $USERNAME_DEFAULT"
echo -e "\033[92mPassword:\033[0m $PASSWORD_DEFAULT"
echo -e "\033[96mRuta de subida:\033[0m /$USERNAME_DEFAULT\n"

