#!/usr/bin/env bash
set -euo pipefail

TS="$(date +%Y%m%d%H%M%S)"
BKDIR="/root/mailcfg_backup_$TS"
sudo mkdir -p "$BKDIR"

POSTFIX_MAIN="/etc/postfix/main.cf"
DOVECOT_CONF="/etc/dovecot/dovecot.conf"
DOVECOT_MASTER="/etc/dovecot/conf.d/10-master.conf"

echo "[*] Backup -> $BKDIR"
sudo cp -a "$POSTFIX_MAIN" "$BKDIR/main.cf"
sudo cp -a "$DOVECOT_CONF" "$BKDIR/dovecot.conf"
sudo cp -a "$DOVECOT_MASTER" "$BKDIR/10-master.conf"

# --- Postfix: safe relay config ---
echo "[*] Updating Postfix: mynetworks + smtpd_recipient_restrictions"

sudo postconf -e "mynetworks=127.0.0.0/8"
sudo postconf -e "smtpd_recipient_restrictions=permit_mynetworks,reject_unauth_destination"

# --- Dovecot: disable plaintext auth ---
echo "[*] Updating Dovecot: disable_plaintext_auth=yes"

if sudo grep -qE '^\s*disable_plaintext_auth\s*=' "$DOVECOT_CONF"; then
  sudo sed -ri 's/^\s*disable_plaintext_auth\s*=.*/disable_plaintext_auth = yes/' "$DOVECOT_CONF"
else
  echo "disable_plaintext_auth = yes" | sudo tee -a "$DOVECOT_CONF" >/dev/null
fi

# --- Dovecot: remove pop3 from protocols ---
if sudo grep -qE '^\s*protocols\s*=' "$DOVECOT_CONF"; then
  sudo sed -ri 's/\bpop3\b//g; s/[[:space:]]+/ /g' "$DOVECOT_CONF"
else
  echo "protocols = imap lmtp submission" | sudo tee -a "$DOVECOT_CONF" >/dev/null
fi

# --- Dovecot: disable submission listener properly (port = 0) ---
echo "[*] Disabling Dovecot submission listener (587 -> port 0)"

if sudo grep -q 'service submission-login' "$DOVECOT_MASTER"; then
  sudo sed -ri '
    /service submission-login/,/}/ {
      s/port *= *587/port = 0/
    }
  ' "$DOVECOT_MASTER"
fi

# --- Validate ---
echo "[*] Validating configs"
sudo postfix check
sudo dovecot -n >/dev/null

# --- Restart ---
echo "[*] Restarting services"
sudo systemctl restart dovecot
sudo systemctl restart postfix

echo "[+] Done."
echo "    Backups in: $BKDIR"
echo "    Rollback:"
echo "      sudo cp -a $BKDIR/main.cf $POSTFIX_MAIN && sudo systemctl restart postfix"
echo "      sudo cp -a $BKDIR/dovecot.conf $DOVECOT_CONF && sudo cp -a $BKDIR/10-master.conf $DOVECOT_MASTER && sudo systemctl restart dovecot"