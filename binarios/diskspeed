#!/usr/bin/env bash
set -euo pipefail

# Function to display important messages with white divider lines and blue text
echo_msg() {
    echo -e "\e[1;37m=============================================="
    echo -e "\e[1;34m$1"
    echo -e "\e[1;37m==============================================\e[0m"
}

# Clean up test files
cleanup() {
  rm -f testfile2 testfile testfile.fio
}

# Defaults
SIZE_MB=1024

usage() {
  cat <<'EOF'
Usage: ./script.sh [-s SIZE_MB]
  -s SIZE_MB   Run tests with SIZE_MB megabytes (default: 1024)

Example:
  ./script.sh -s 400
EOF
}

# Parse args
while getopts ":s:h" opt; do
  case "$opt" in
    s)
      SIZE_MB="$OPTARG"
      ;;
    h)
      usage
      exit 0
      ;;
    \?)
      echo "Unknown option: -$OPTARG" >&2
      usage >&2
      exit 1
      ;;
    :)
      echo "Option -$OPTARG requires an argument." >&2
      usage >&2
      exit 1
      ;;
  esac
done
shift $((OPTIND - 1))

# Validate SIZE_MB
if ! [[ "$SIZE_MB" =~ ^[0-9]+$ ]] || [ "$SIZE_MB" -le 0 ]; then
  echo "Invalid -s value: must be a positive integer (MB)." >&2
  exit 1
fi

cleanup

# Informational message
if [ "$SIZE_MB" -eq 1024 ]; then
  echo_msg "Running disk tests with default size: 1024 MB\nTip: you can set size in MB with: -s <MB>  (example: ./script.sh -s 400)"
else
  echo_msg "Running disk tests with custom size: ${SIZE_MB} MB"
fi

DD_COUNT_MB="$SIZE_MB"
FIO_SIZE="${SIZE_MB}M"

##############################################
# DD Tests (Write and Read) - without cache, bs=1M
##############################################
echo -e "\e[1;37m_________________________________________________________\e[0m"

# Run dd write test (show progress live + capture output)
dd_write_log="$(mktemp)"
dd if=/dev/zero of=testfile2 bs=1M count="$DD_COUNT_MB" oflag=direct status=progress \
  2> >(tee "$dd_write_log" >&2)
dd_write_last_line=$(tail -n 1 "$dd_write_log")
rm -f "$dd_write_log"

dd_write_speed_raw=$(echo "$dd_write_last_line" | awk -F', ' '{print $NF}')
dd_write_number=$(echo "$dd_write_speed_raw" | awk '{print $1}')
dd_write_unit=$(echo "$dd_write_speed_raw" | awk '{print $2}')

if [ "$dd_write_unit" == "GB/s" ]; then
  dd_write_speed=$(awk "BEGIN {printf \"%.2f\", $dd_write_number * 1024}")
elif [ "$dd_write_unit" == "MB/s" ]; then
  dd_write_speed=$dd_write_number
elif [ "$dd_write_unit" == "KB/s" ]; then
  dd_write_speed=$(awk "BEGIN {printf \"%.2f\", $dd_write_number/1024}")
else
  dd_write_speed="N/A"
fi

# Run dd read test (show progress live + capture output)
dd_read_log="$(mktemp)"
dd if=testfile2 of=/dev/null bs=1M iflag=direct status=progress \
  2> >(tee "$dd_read_log" >&2)
dd_read_last_line=$(tail -n 1 "$dd_read_log")
rm -f "$dd_read_log"

dd_read_speed_raw=$(echo "$dd_read_last_line" | awk -F', ' '{print $NF}')
dd_read_number=$(echo "$dd_read_speed_raw" | awk '{print $1}')
dd_read_unit=$(echo "$dd_read_speed_raw" | awk '{print $2}')

if [ "$dd_read_unit" == "GB/s" ]; then
  dd_read_speed=$(awk "BEGIN {printf \"%.2f\", $dd_read_number * 1024}")
elif [ "$dd_read_unit" == "MB/s" ]; then
  dd_read_speed=$dd_read_number
elif [ "$dd_read_unit" == "KB/s" ]; then
  dd_read_speed=$(awk "BEGIN {printf \"%.2f\", $dd_read_number/1024}")
else
  dd_read_speed="N/A"
fi

dd_message="Running dd test (oflag=direct, bs=1M, size=${SIZE_MB}MB)...\n\
dd Write Speed: ${dd_write_speed} MB/s\n\
dd Read Speed: ${dd_read_speed} MB/s"

echo_msg "$dd_message"

##############################################
# Fio Tests (Write and Read)
##############################################
echo -e "\e[1;37m_________________________________________________________\e[0m"

# Run fio write test
fio_write_output=$(fio --name=write_test --filename=testfile --size="$FIO_SIZE" --bs=1M --rw=write --ioengine=sync --fdatasync=1 2>&1)
fio_write_bw=$(echo "$fio_write_output" | grep -oP 'BW=\K[0-9]+(?=MiB/s)' | head -n 1)

# Run fio read test
fio_read_output=$(fio --name=read_test --filename=testfile --size="$FIO_SIZE" --bs=1M --rw=read --ioengine=sync 2>&1)
fio_read_bw=$(echo "$fio_read_output" | grep -oP 'BW=\K[0-9]+(?=MiB/s)' | head -n 1)

fio_message="Running fio test (size=${SIZE_MB}MB)...\n\
fio Write Speed: ${fio_write_bw:-N/A} MB/s\n\
fio Read Speed: ${fio_read_bw:-N/A} MB/s"

echo_msg "$fio_message"

cleanup