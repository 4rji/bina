#!/usr/bin/env bash
set -euo pipefail

# Must run as a normal user (script will handle sudo internally)

echo "[*] Installing packages..."
sudo apt update
sudo apt install -y unbound unbound-anchor curl

echo "[*] Creating required directories..."
sudo mkdir -p /var/lib/unbound
sudo mkdir -p /etc/unbound

echo "[*] Downloading root.hints..."
curl -s https://www.internic.net/domain/named.root \
  | sudo tee /var/lib/unbound/root.hints >/dev/null

echo "[*] Initializing/updating root.key..."
sudo unbound-anchor -a "/var/lib/unbound/root.key" || true

echo "[*] Backing up old Unbound config (if exists)..."
if [[ -f /etc/unbound/unbound.conf && ! -f /etc/unbound/unbound.conf.bak ]]; then
  sudo cp /etc/unbound/unbound.conf /etc/unbound/unbound.conf.bak
fi

echo "[*] Downloading custom unbound.conf..."
sudo curl -s https://raw.githubusercontent.com/4rji/dotfiles/refs/heads/main/unbound.conf \
  -o /etc/unbound/unbound.conf

echo "[*] Checking config syntax..."
sudo unbound-checkconf

echo "[*] Restarting Unbound..."
sudo systemctl restart unbound

echo "[*] Unbound status:"
sudo systemctl status unbound --no-pager

echo "[*] Installing monthly cron job for root.hints update..."
CRON_LINE='0 3 1 * * curl -s https://www.internic.net/domain/named.root | tee /var/lib/unbound/root.hints >/dev/null'

( crontab -l 2>/dev/null | grep -v 'internic.net/domain/named.root' ; echo "$CRON_LINE" ) | crontab -

echo "[*] Done. Unbound configured and cron installed."