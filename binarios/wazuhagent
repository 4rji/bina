#!/usr/bin/env bash
set -euo pipefail

WAZUH_VERSION_APT="4.13.1-1"
WAZUH_VERSION_RPM="4.13.1-1"

have() { command -v "$1" >/dev/null 2>&1; }

detect_pm() {
  if have apt-get; then echo "apt"
  elif have dnf; then echo "dnf"
  elif have yum; then echo "yum"
  else echo "none"
  fi
}

ask_manager_ip() {
  local ip
  read -rp "Enter Wazuh Manager IP: " ip
  if [[ -z "${ip// }" ]]; then
    echo "[!] Manager IP cannot be empty."
    exit 1
  fi
  echo "$ip"
}

ensure_manager_ip_in_conf() {
  local ip="$1"
  local conf="/var/ossec/etc/ossec.conf"

  if [[ ! -f "$conf" ]]; then
    echo "[!] $conf not found yet."
    return 0
  fi

  if grep -q "<address>.*</address>" "$conf"; then
    sudo sed -i "s#<address>.*</address>#<address>${ip}</address>#g" "$conf"
  else
    sudo sed -i "/<ossec_config>/a\\
  <client>\\
    <server>\\
      <address>${ip}</address>\\
    </server>\\
  </client>\\
" "$conf"
  fi
}

install_wazuh_apt() {
  local ip="$1"

  curl -s https://packages.wazuh.com/key/GPG-KEY-WAZUH \
    | sudo gpg --no-default-keyring --keyring gnupg-ring:/usr/share/keyrings/wazuh.gpg --import
  sudo chmod 644 /usr/share/keyrings/wazuh.gpg

  echo "deb [signed-by=/usr/share/keyrings/wazuh.gpg] https://packages.wazuh.com/4.x/apt/ stable main" \
    | sudo tee /etc/apt/sources.list.d/wazuh.list >/dev/null

  sudo apt-get update
  sudo WAZUH_MANAGER="$ip" apt-get install -y "wazuh-agent=${WAZUH_VERSION_APT}" || true

  ensure_manager_ip_in_conf "$ip"

  sudo systemctl daemon-reload
  sudo systemctl enable --now wazuh-agent
}

install_wazuh_rpm() {
  local pm="$1"
  local ip="$2"

  sudo rpm --import https://packages.wazuh.com/key/GPG-KEY-WAZUH

  sudo tee /etc/yum.repos.d/wazuh.repo >/dev/null << 'EOF'
[wazuh]
gpgcheck=1
gpgkey=https://packages.wazuh.com/key/GPG-KEY-WAZUH
enabled=1
name=EL-$releasever - Wazuh
baseurl=https://packages.wazuh.com/4.x/yum/
priority=1
EOF

  if [ "$pm" = "dnf" ]; then
    sudo dnf clean all
    sudo dnf makecache
  else
    sudo yum clean all
    sudo yum makecache
  fi

  sudo WAZUH_MANAGER="$ip" "$pm" install -y "wazuh-agent-${WAZUH_VERSION_RPM}" || true

  ensure_manager_ip_in_conf "$ip"

  sudo systemctl daemon-reload
  sudo systemctl enable --now wazuh-agent
}

disable_repo_apt() {
  sudo sed -i 's/^deb/#deb/' /etc/apt/sources.list.d/wazuh.list 2>/dev/null || true
  sudo apt-get update
}

disable_repo_rpm() {
  sudo sed -i 's/^enabled=1/enabled=0/' /etc/yum.repos.d/wazuh.repo 2>/dev/null || true
}

post_install_help() {
  local ip="$1"
  cat <<EOF

=== Wazuh Agent Quick Commands ===

Logs (agent):
  sudo tail -f /var/ossec/logs/ossec.log

Check current manager IP:
  sudo grep -n "<address>" /var/ossec/etc/ossec.conf

Change manager IP to NEW_IP:
  sudo nano /var/ossec/etc/ossec.conf
  sudo systemctl restart wazuh-agent

Test connectivity to manager (enrollment port):
  nc -vz ${ip} 1515   2>/dev/null || true

Service status:
  sudo systemctl status wazuh-agent --no-pager

EOF
}

pm="$(detect_pm)"
if [ "$pm" = "none" ]; then
  echo "[!] No supported package manager found (apt/dnf/yum)."
  exit 1
fi

echo
echo "=== Wazuh Agent Menu ($pm) ==="
echo "1) Install Wazuh agent"
echo "2) Disable Wazuh repo"
echo "3) Exit"
echo

read -rp "Select option [1-3]: " opt

case "$opt" in
  1)
    ip="$(ask_manager_ip)"
    echo "[*] Installing Wazuh agent -> manager: $ip"
    if [ "$pm" = "apt" ]; then
      install_wazuh_apt "$ip"
    else
      install_wazuh_rpm "$pm" "$ip"
    fi
    echo "[OK] Wazuh agent installed and started."
    post_install_help "$ip"
    ;;
  2)
    echo "[*] Disabling Wazuh repo"
    if [ "$pm" = "apt" ]; then
      disable_repo_apt
    else
      disable_repo_rpm
    fi
    echo "[OK] Repo disabled."
    ;;
  3) exit 0 ;;
  *) echo "[!] Invalid option."; exit 1 ;;
esac


sudo tail /var/ossec/logs/ossec.log