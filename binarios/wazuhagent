#!/usr/bin/env bash
set -euo pipefail

WAZUH_VER="4.14.1-1"
GROUP="default"

ask() { local p="$1" v; read -r -p "$p" v; printf '%s' "$v"; }

arch_norm() {
  case "$(uname -m)" in
    x86_64|amd64) echo "x86_64" ;;
    aarch64|arm64) echo "aarch64" ;;
    *) echo "unknown" ;;
  esac
}

need_cmd() {
  command -v "$1" >/dev/null 2>&1 || { echo "Missing required command: $1" >&2; exit 1; }
}

start_agent() {
  sudo systemctl daemon-reload
  sudo systemctl enable wazuh-agent
  sudo systemctl start wazuh-agent
}

echo "=== Wazuh Agent (Linux) installer ==="

MANAGER_IP="$(ask "Wazuh Manager IP: ")"
AGENT_NAME="$(ask "Agent name: ")"

echo
echo "Select distro:"
echo "  1) Ubuntu (DEB amd64)"
echo "  2) Fedora / Oracle (RPM x86_64 or aarch64)"
DISTRO_CHOICE="$(ask "Choice [1-2]: ")"

ARCH="$(arch_norm)"
[[ "$ARCH" == "unknown" ]] && { echo "Unsupported architecture: $(uname -m)" >&2; exit 1; }

tmpdir="$(mktemp -d)"
trap 'rm -rf "$tmpdir"' EXIT

case "$DISTRO_CHOICE" in
  1)
    need_cmd wget
    if [[ "$ARCH" != "x86_64" ]]; then
      echo "Ubuntu path is set for DEB amd64 only. Detected arch: $ARCH" >&2
      exit 1
    fi

    DEB="wazuh-agent_${WAZUH_VER}_amd64.deb"
    URL="https://packages.wazuh.com/4.x/apt/pool/main/w/wazuh-agent/${DEB}"

    echo "Downloading: $URL"
    wget -q -O "$tmpdir/$DEB" "$URL"

    echo "Installing .deb..."
    sudo WAZUH_MANAGER="$MANAGER_IP" WAZUH_AGENT_NAME="$AGENT_NAME" WAZUH_AGENT_GROUP="$GROUP" \
      dpkg -i "$tmpdir/$DEB"

    start_agent
    ;;

  2)
    need_cmd curl

    RPM_ARCH="$ARCH" # x86_64 or aarch64
    RPM="wazuh-agent-${WAZUH_VER}.${RPM_ARCH}.rpm"
    URL="https://packages.wazuh.com/4.x/yum/${RPM}"

    echo "Downloading: $URL"
    curl -fsSL -o "$tmpdir/$RPM" "$URL"

    echo "Installing .rpm..."
    sudo WAZUH_MANAGER="$MANAGER_IP" WAZUH_AGENT_NAME="$AGENT_NAME" WAZUH_AGENT_GROUP="$GROUP" \
      rpm -ihv "$tmpdir/$RPM"

    start_agent
    ;;

  *)
    echo "Invalid choice. Use 1 or 2." >&2
    exit 1
    ;;
esac

echo
echo "Done."

sudo /usr/share/wazuh-indexer/plugins/opensearch-security/tools/wazuh-passwords-tool.sh -u admin -p "M3tr0123*"