#!/usr/bin/env bash
set -e

echo_msg() {
    echo ""
    echo "=============================================="
    echo "$1"
    echo "=============================================="
    echo ""
}

usage() {
  echo -e "\033[36mUsage:\033[0m  $0 -i (install server)  |  -c (configure client Linux)  |  -m (configure client macOS)"
  echo ""
  exit 1
}

[ $# -eq 0 ] && usage

while getopts "icm" opt; do
  case "$opt" in
    i)
      echo_msg "SERVER INSTALL (Debian/Ubuntu)"
      sudo apt update
      sudo apt install -y shadowsocks-libev
      cat <<EOF | sudo tee /etc/shadowsocks-libev/config.json
{
    "server": "0.0.0.0",
    "server_port": 8388,
    "password": "nalanga12",
    "method": "aes-256-gcm",
    "timeout": 300,
    "fast_open": true
}
EOF
      sudo systemctl enable shadowsocks-libev
      sudo systemctl restart shadowsocks-libev
      echo_msg "SERVER READY ON PORT 8388"
      ;;
    c)
      echo_msg "CLIENT CONFIGURATION (Linux)"
      read -p $'\033[33mServer IP: \033[0m' IP
      sudo apt update
      sudo apt install -y shadowsocks-libev
      cat <<EOF > ~/.shadowsock-cl.json
{
    "server": "$IP",
    "server_port": 8388,
    "local_address": "127.0.0.1",
    "local_port": 1080,
    "password": "nalanga12",
    "method": "aes-256-gcm"
}
EOF
      echo_msg "CLIENT CONFIGURED"
      echo -e "\033[36mRun in foreground:\033[0m  ss-local -c ~/.shadowsock-cl.json -v"
      echo -e "\033[35mRun in background:\033[0m  ss-local -c ~/.shadowsock-cl.json -v &"
      echo -e "\033[33mQuick test:\033[0m  curl --socks5 127.0.0.1:1080 https://ifconfig.me"
      ;;
    m)
      echo_msg "CLIENT CONFIGURATION (macOS)"
      read -p $'\033[33mServer IP: \033[0m' IP
      brew install shadowsocks-libev
      cat <<EOF > ~/ss-client.json
{
    "server": "$IP",
    "server_port": 8388,
    "local_address": "127.0.0.1",
    "local_port": 1080,
    "password": "nalanga12",
    "method": "aes-256-gcm"
}
EOF
      echo_msg "CLIENT CONFIGURED (macOS)"
      echo -e "\033[36mRun in foreground:\033[0m  ss-local -c ~/ss-client.json -v"
      echo -e "\033[35mRun in background:\033[0m  ss-local -c ~/ss-client.json -v &"
      echo -e "\033[33mQuick test:\033[0m  curl --socks5 127.0.0.1:1080 https://ifconfig.me"
      ;;
    *)
      usage
      ;;
  esac
done