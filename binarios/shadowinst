#!/usr/bin/env bash
set -e

# ==============================================
# Message helper
echo_msg() {
    echo ""
    echo "=============================================="
    echo "$1"
    echo "=============================================="
    echo ""
}
# ==============================================

usage() {
  echo -e "\033[36mUsage:\033[0m  $0 -i (install server)  |  -c (configure client)"
  echo ""
  exit 1
}

[ $# -eq 0 ] && usage

while getopts "ic" opt; do
  case "$opt" in
    i)
      echo ""
      echo "_________________________________________________________"
      echo ""
      echo -e "\033[35m>>> Installing Shadowsocks server...\033[0m"
      echo ""

      #sudo apt update
      sudo apt install -y shadowsocks-libev

      cat <<EOF | sudo tee /etc/shadowsocks-libev/config.json
{
    "server": "0.0.0.0",
    "server_port": 8388,
    "password": "nalanga12",
    "method": "aes-256-gcm",
    "timeout": 300,
    "fast_open": true
}
EOF

      sudo systemctl enable shadowsocks-libev
      sudo systemctl restart shadowsocks-libev

      echo_msg "SERVER READY ON PORT 8388"
      echo -e "\033[32mCheck listening port:\033[0m  ss -lnpt | grep 8388"
      echo ""
      echo "_________________________________________________________"
      echo ""
      ;;
    c)
      echo ""
      echo "_________________________________________________________"
      echo ""
      echo -e "\033[34m>>> Configuring Shadowsocks client...\033[0m"
      echo ""

      read -p $'\033[33mServer IP: \033[0m' IP
      echo ""

     # sudo apt update
      sudo apt install -y shadowsocks-libev

      cat <<EOF > ~/.shadowsock-cl.json
{
    "server": "$IP",
    "server_port": 8388,
    "local_address": "127.0.0.1",
    "local_port": 1080,
    "password": "nalanga12",
    "method": "aes-256-gcm"
}
EOF

      echo_msg "CLIENT CONFIGURED"

      echo -e "\033[36mRun in foreground:\033[0m"
      echo "  ss-local -c ~/.shadowsock-cl.json -v"
      echo ""

      echo -e "\033[35mRun in background with &:\033[0m"
      echo "  ss-local -c ~/.shadowsock-cl.json -v &"
      echo ""

      echo -e "\033[32mRun with nohup (no extra log redirection):\033[0m"
      echo "  nohup ss-local -c ~/.shadowsock-cl.json -v &"
      echo ""

      echo -e "\033[33mQuick test through SOCKS5 proxy:\033[0m"
      echo "  curl --socks5 127.0.0.1:1080 https://ifconfig.me"
      echo ""
      echo "_________________________________________________________"
      echo ""
      ;;
    *)
      usage
      ;;
  esac
done