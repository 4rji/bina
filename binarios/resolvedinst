#!/usr/bin/env bash
# Debian — Install & switch to systemd-resolved in 5 steps (with ANSI, no color vars).

set -euo pipefail

echo_msg() {
  echo "=============================================="
  echo "$1"
  echo "=============================================="
}

run_cmd() {
  echo -e "\033[2m$*\033[0m"
  eval "$@"
}

has(){ command -v "$1" >/dev/null 2>&1; }

echo ""
echo "_________________________________________________________"
echo ""

echo_msg "$(echo -e "\033[1;36m  Install systemd-resolved (Debian) — 5 steps  \033[0m")"

# -------- Step 1 --------
echo -e "\033[1;35m  [1] Install package  \033[0m"
echo ""
echo "_________________________________________________________"
echo ""
run_cmd sudo apt update
run_cmd sudo apt install -y systemd-resolved

# -------- Step 2 --------
echo -e "\033[1;34m  [2] Enable & start service  \033[0m"
echo ""
echo "_________________________________________________________"
echo ""
run_cmd sudo systemctl enable --now systemd-resolved

# -------- Step 3 --------
echo -e "\033[1;33m  [3] Point /etc/resolv.conf to the stub  \033[0m"
echo ""
echo "_________________________________________________________"
echo ""
if [ ! -e /etc/resolv.conf.bak ]; then
  run_cmd sudo cp -a /etc/resolv.conf /etc/resolv.conf.bak || true
fi
run_cmd sudo ln -sf /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf

# -------- Step 4 --------
echo -e "\033[1;32m  [4] Configure Quad9 DNS in /etc/systemd/resolved.conf  \033[0m"
echo ""
echo "_________________________________________________________"
echo ""
# ensure [Resolve] exists and configure DNS line properly
if ! grep -q "^\[Resolve\]" /etc/systemd/resolved.conf; then
  run_cmd "echo '[Resolve]' | sudo tee /etc/systemd/resolved.conf > /dev/null"
fi
run_cmd "sudo sed -i '/^DNS=/d' /etc/systemd/resolved.conf"
run_cmd "sudo sed -i '/^\[Resolve\]/a DNS=9.9.9.9#dns.quad9.net 149.112.112.112#dns.quad9.net 2620:fe::fe#dns.quad9.net 2620:fe::9#dns.quad9.net' /etc/systemd/resolved.conf"

# restart to apply
run_cmd sudo systemctl restart systemd-resolved

# -------- Step 5 --------
echo -e "\033[1;32m  [5] Verify status  \033[0m"
echo ""
echo "_________________________________________________________"
echo ""
if has resolvectl; then
  run_cmd resolvectl status || true
else
  echo -e "\033[1;31m  resolvectl not found (should be present with systemd-resolved).  \033[0m"
fi

# -------- Final summary --------
echo ""
echo "_________________________________________________________"
echo ""
ACTIVE="unknown"
if systemctl -q is-active systemd-resolved; then
  if [ -L /etc/resolv.conf ] && readlink -f /etc/resolv.conf | grep -q '/run/systemd/resolve/stub-resolv.conf'; then
    DNS_SERVERS="$(resolvectl dns 2>/dev/null | awk '{print $2}' | paste -sd' ' - 2>/dev/null || true)"
    [ -z "$DNS_SERVERS" ] && DNS_SERVERS="$(grep -E '^nameserver' /run/systemd/resolve/stub-resolv.conf 2>/dev/null | awk '{print $2}' | paste -sd' ' -)"
    ACTIVE="systemd-resolved → stub 127.0.0.53 → [${DNS_SERVERS:-auto}]"
  else
    ACTIVE="systemd-resolved running, but /etc/resolv.conf not pointing to stub"
  fi
else
  ACTIVE="systemd-resolved not active"
fi

echo_msg "$(echo -e "\033[1;36m  Active DNS resolver: $ACTIVE  \033[0m")"

echo ""
echo "_________________________________________________________"
echo ""
echo -e "\033[1;36m  Done.  \033[0m"