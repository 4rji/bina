#!/usr/bin/env bash

echo -e "\n\033[1;33m_________________________________________________________\033[0m\n"

# Archivos temporales para hosts online y offline
onlineFile=$(mktemp)
offlineFile=$(mktemp)

# Códigos de colores
BLUE="\e[34m"
WHITE="\e[37m"
GREEN="\e[32m"
RED="\e[31m"
RESET="\e[0m"

# Arrays paralelos para alias, hostname y puertos
aliases=()
hostnames=()
ports=()
current_indices=()

# Procesar el archivo de configuración SSH
while read -r line; do
    line=$(echo "$line" | sed 's/#.*//;s/^\s*//;s/\s*$//')
    [[ -z "$line" ]] && continue

    key=$(echo "$line" | awk '{print tolower($1)}')
    value=$(echo "$line" | awk '{print $2}')

    if [[ "$key" == "host" ]]; then
        IFS=' ' read -r -a host_array <<< "$value"
        current_indices=()
        for host in "${host_array[@]}"; do
            aliases+=("$host")
            hostnames+=("")
            ports+=(22)
            idx=$((${#aliases[@]} - 1))
            current_indices+=("$idx")
        done
    elif [[ "$key" == "hostname" ]]; then
        for idx in "${current_indices[@]}"; do
            hostnames[$idx]="$value"
        done
    elif [[ "$key" == "port" ]]; then
        for idx in "${current_indices[@]}"; do
            ports[$idx]="$value"
        done
    fi
done < ~/.ssh/config

# Procesar cada host
for idx in "${!aliases[@]}"; do
    host="${aliases[$idx]}"
    hostname="${hostnames[$idx]}"
    port="${ports[$idx]}"
    [[ -z "$hostname" ]] && hostname="$host"
    
    {
        if nc -zv -w1 "$hostname" "$port" &>/dev/null; then
            echo -e "${BLUE}${host}${RESET} - ${WHITE}${hostname}:${port}${RESET} (${GREEN}online${RESET})" >> "$onlineFile"
        else
            echo -e "${BLUE}${host}${RESET} - ${WHITE}${hostname}:${port}${RESET} (${RED}offline${RESET})" >> "$offlineFile"
        fi
    } &
done

wait

echo -e "Online:"
sort "$onlineFile"
echo -e "\n\033[1;33m_________________________________________________________\033[0m\n"
echo -e "\nOffline:"
sort "$offlineFile"

rm "$onlineFile" "$offlineFile"

echo -e "\n\033[1;33m_________________________________________________________\033[0m\n"